<app-header></app-header>

<br><br><br><br><br><br>

<div class="container pre-cadastros-view">

  <!-- âœ… Toast de feedback -->
  <div *ngIf="toastVisivel()" class="alert alert-success shadow-sm border-0">
    Status atualizado com sucesso!
  </div>

  <!-- Header / Hero -->
  <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <div class="crn-kicker"></div>
      <div>
        <h3 class="mb-0 text-crn-dark fw-bold">Minha Lista</h3>
        <div class="mt-1 d-flex align-items-center gap-2 flex-wrap">
          <span class="text-muted" style="font-size:.9rem">Visualize seus atendimentos por Pessoas ou por Grupos</span>
          <br><br>
        </div>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a routerLink="/pre-cadastro/novo" class="btn btn-principal">
        <i class="bi bi-plus-lg me-1"></i> Novo
      </a>
      <a routerLink="/agendamentos" class="btn btn-outline-success">
        <i class="bi bi-calendar2-week me-1"></i> Meus agendamentos
      </a>
    </div>
  </div>

  <!-- ===== Abas Pessoas | Grupos ===== -->
  <div class="mt-3">
    <div class="btn-group" role="tablist" aria-label="Alternar visÃ£o">
      <button type="button" class="btn" [class.btn-success]="aba()==='pessoas'"
        [class.btn-outline-success]="aba()!=='pessoas'" (click)="setAba('pessoas')" role="tab"
        [attr.aria-selected]="aba()==='pessoas' ? 'true' : 'false'">
        <i class="bi bi-person-lines-fill me-1"></i> Pessoas
      </button>

      <button type="button" class="btn" [class.btn-success]="aba()==='grupos'"
        [class.btn-outline-success]="aba()!=='grupos'" (click)="setAba('grupos')" role="tab"
        [attr.aria-selected]="aba()==='grupos' ? 'true' : 'false'">
        <i class="bi bi-people-fill me-1"></i> Grupos
      </button>
    </div>
  </div>

  <!-- ======================= ABA: PESSOAS ======================= -->
  <ng-container *ngIf="aba()==='pessoas'">

    <!-- Toolbar: Busca + Filtros -->
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body py-3">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-lg-4">
            <label class="form-label mb-1">Buscar por nome</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="search" class="form-control" placeholder="Digite o nome do clienteâ€¦" [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event)" />
            </div>
          </div>

          <div class="col-6 col-lg-2">
            <label class="form-label mb-1">Status</label>
            <select class="form-select" [ngModel]="filtroStatus()" (ngModelChange)="filtroStatus.set($event)">
              <option value="todos">Todos</option>
              <option value="nao_agendado">NÃ£o agendado</option>
              <option value="agendado">Agendado</option>
              <option value="visitado">Visita realizada</option>
            </select>
          </div>

          <div class="col-6 col-lg-2">
            <label class="form-label mb-1">Data inÃ­cio</label>
            <input type="date" class="form-control" [ngModel]="filtroDataIni()"
              (ngModelChange)="filtroDataIni.set($event)" />
          </div>

          <div class="col-6 col-lg-2">
            <label class="form-label mb-1">Data fim</label>
            <input type="date" class="form-control" [ngModel]="filtroDataFim()"
              (ngModelChange)="filtroDataFim.set($event)" />
          </div>

          <div class="col-12 col-lg-2">
            <div class="mt-4">
              <span class="badge-soft me-2">Total: {{ totalGeral() }}</span>
              <span class="badge-soft">Filtrados: {{ totalFiltrado() }}</span>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading()" class="alert alert-light border-0 shadow-sm d-flex align-items-center gap-2">
      <span class="spinner-border spinner-border-sm"></span>
      Carregandoâ€¦
    </div>

    <!-- Lista em cards (Pessoas) -->
    <div class="card shadow-sm border-0" *ngIf="!loading()">
      <div class="card-body">

        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
          <div class="col" *ngFor="let i of pagedItems()">
            <div class="crn-card h-100 d-flex flex-column" [class.crn-card--highlight]="i.id === highlightId()">

              <!-- CabeÃ§alho -->
              <div class="crn-card__header d-flex align-items-center gap-3">
                <div class="avatar-inicial">
                  {{ (i.nomeCompleto || '?').charAt(0) | uppercase }}
                </div>
                <div class="min-w-0">
                  <div class="fw-semibold truncate-2 mb-2 mt-2 text-crn-dark">
                    {{ i.nomeCompleto || 'â€”' }}
                  </div>
                  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                    <small class="text-muted">PrÃ©-cadastro</small>
                    <!-- Badge de Grupo (quando pertence a um grupo) -->
                    <ng-container *ngIf="i.grupoId">
                      <span class="badge text-bg-success" title="Pertence a um grupo">
                        Grupo:
                        {{ ($any(i).grupoNome || (i.papelNoGrupo==='coordenador' ? 'Coordenador' : 'Membro')) }}
                      </span>
                    </ng-container>
                  </div>
                </div>
              </div>

              <!-- Corpo -->
              <div class="crn-card__body">
                <div class="crn-field">
                  <span class="crn-label">CPF</span>
                  <span class="crn-value"><span class="badge text-bg-light fw-medium">{{ i.cpf || 'â€”' }}</span></span>
                </div>

                <div class="crn-field">
                  <span class="crn-label">Telefone</span>
                  <span class="crn-value"><i class="bi bi-telephone text-crn me-1"></i> {{ i.telefone || 'â€”' }}</span>
                </div>

                <div class="crn-field">
                  <span class="crn-label">EndereÃ§o</span>
                  <span class="crn-value text-break">{{ i.endereco || 'â€”' }}</span>
                </div>

                <div class="crn-field">
                  <span class="crn-label">Bairro</span>
                  <span class="crn-value text-break">{{ i.bairro || 'â€”' }}</span>
                </div>

                <!-- Cidade/UF + bandeira -->
                <div class="crn-field">
                  <span class="crn-label">Cidade/UF</span>
                  <span class="crn-value d-flex align-items-center gap-2">
                    <span class="text-break">
                      {{ (i.cidade || 'â€”') }}
                      <ng-container *ngIf="i.uf; else noUF">
                        â€¢ <span class="uf-text">{{ i.uf.toUpperCase() }}</span>
                      </ng-container>
                      <ng-template #noUF></ng-template>
                    </span>
                    <span *ngIf="i.uf" class="uf-flag" [ngClass]="
                        (i.uf.toLowerCase()==='pa') ? 'flag-pa' :
                        (i.uf.toLowerCase()==='am') ? 'flag-am' :
                        (i.uf.toLowerCase()==='ap') ? 'flag-ap' : 'flag-br'
                      " [title]="'Bandeira ' + (i.uf.toUpperCase() || 'BR')" aria-hidden="true"></span>
                  </span>
                </div>

                <!-- AprovaÃ§Ã£o -->
                <div class="crn-field">
                  <span class="crn-label">AprovaÃ§Ã£o</span>
                  <span class="crn-value">
                    <span class="badge" [ngClass]="{
                        'text-bg-secondary': (i.aprovacao?.status || 'nao_verificado')==='nao_verificado',
                        'text-bg-danger':    (i.aprovacao?.status || 'nao_verificado')==='inapto',
                        'text-bg-success':   (i.aprovacao?.status || 'nao_verificado')==='apto'
                      }">
                      {{
                      (i.aprovacao?.status || 'nao_verificado')==='nao_verificado' ? 'NÃ£o verificado' :
                      (i.aprovacao?.status==='apto' ? 'Apto' : 'Inapto')
                      }}
                    </span>
                    <small class="text-muted ms-2" *ngIf="$any(i)?.aprovacao?.porNome">
                      por {{ $any(i).aprovacao.porNome }}
                      <ng-container *ngIf="$any(i)?.aprovacao?.em as em">
                        â€” {{ (em?.toDate ? em.toDate() : em) | date:'dd/MM/yyyy HH:mm' }}
                      </ng-container>
                    </small>
                  </span>
                </div>

                <!-- Encaminhado -->
                <div class="crn-field" *ngIf="encaminhadoParaMim(i)">
                  <span class="crn-label">Encaminhado</span>
                  <span class="crn-value">
                    por {{ encaminhadoPorNome(i) || 'Analista' }}
                    <small class="text-muted" *ngIf="encaminhadoQuando(i)">
                      â€” {{ encaminhadoQuando(i) | date:'dd/MM/yyyy HH:mm' }}
                    </small>
                  </span>
                </div>

                <!-- Agendamento -->
                <div class="crn-field">
                  <span class="crn-label">Agendamento</span>
                  <span class="crn-value">
                    <span class="badge" [ngClass]="{
                        'text-bg-secondary': (i.agendamentoStatus || 'nao_agendado')==='nao_agendado',
                        'text-bg-info':      (i.agendamentoStatus || 'nao_agendado')==='agendado',
                        'text-bg-success':   (i.agendamentoStatus || 'nao_agendado')==='visitado'
                      }">
                      {{
                      (i.agendamentoStatus || 'nao_agendado') === 'nao_agendado' ? 'NÃ£o agendado' :
                      (i.agendamentoStatus || 'nao_agendado') === 'agendado' ? 'Agendado' : 'Visitado'
                      }}
                    </span>
                  </span>
                </div>

                <!-- FormalizaÃ§Ã£o -->
                <div class="crn-field">
                  <span class="crn-label">FormalizaÃ§Ã£o</span>
                  <span class="crn-value">
                    <span class="badge" [ngClass]="formalizacaoBadgeClass(i)">
                      {{ formalizacaoStatus(i) === 'formalizado' ? 'Formalizado' : 'NÃ£o formalizado' }}
                    </span>
                    <small class="text-muted ms-2" *ngIf="$any(i)?.formalizacao?.porNome">
                      por {{ $any(i).formalizacao.porNome }}
                      <ng-container *ngIf="$any(i)?.formalizacao?.em as emFml">
                        â€” {{ (emFml?.toDate ? emFml.toDate() : emFml) | date:'dd/MM/yyyy HH:mm' }}
                      </ng-container>
                    </small>
                  </span>
                </div>

                <!-- DesistÃªncia -->
                <div class="crn-field">
                  <span class="crn-label">DesistÃªncia</span>
                  <span class="crn-value">
                    <span class="badge" [ngClass]="desistenciaBadgeClass(i)">
                      {{ desistenciaStatus(i) === 'desistiu' ? 'Desistiu' : 'NÃ£o desistiu' }}
                    </span>
                    <small class="text-muted ms-2" *ngIf="$any(i)?.desistencia?.porNome">
                      por {{ $any(i).desistencia.porNome }}
                      <ng-container *ngIf="$any(i)?.desistencia?.em as emDes">
                        â€” {{ (emDes?.toDate ? emDes.toDate() : emDes) | date:'dd/MM/yyyy HH:mm' }}
                      </ng-container>
                    </small>
                    <div class="text-muted mt-1" *ngIf="$any(i)?.desistencia?.observacao as obs">
                      <i class="bi bi-chat-left-quote me-1"></i>
                      <em>Obs.:</em> {{ obs }}
                    </div>
                  </span>
                </div>

                <!-- ObservaÃ§Ãµes (resumo) -->
                <div class="crn-field" *ngIf="i.observacoes">
                  <span class="crn-label">ObservaÃ§Ãµes</span>
                  <span class="crn-value text-break">
                    {{ i.observacoes }}
                  </span>
                </div>

              </div>

              <!-- ===== Toggle & RodapÃ© do card ===== -->
              <input type="checkbox" class="crn-actions-toggle" [attr.id]="'acoes-toggle-'+i.id" #acToggle
                aria-hidden="true" />

              <div class="crn-card__footer-actions">
                <label class="crn-actions-open" role="button" [attr.for]="'acoes-toggle-'+i.id"
                  [attr.aria-controls]="'acoes-modal-'+i.id" aria-expanded="false">
                  <i class="bi bi-list-task"></i>
                  <span class="crn-actions-open__label">Realizar uma aÃ§Ã£o</span>
                  <i class="bi bi-chevron-right ms-1"></i>
                </label>
              </div>

              <!-- 3) Modal que aparece quando o checkbox estÃ¡ checked -->
              <div class="crn-modal-toggle-target" [attr.id]="'acoes-modal-'+i.id" role="dialog" aria-modal="true"
                [attr.aria-labelledby]="'acoesTitulo-' + i.id">

                <!-- Backdrop fecha o modal -->
                <label class="crn-modal__backdrop" [attr.for]="'acoes-toggle-'+i.id" aria-label="Fechar"></label>

                <div class="crn-modal__dialog">
                  <div class="crn-modal__header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0" [attr.id]="'acoesTitulo-' + i.id">AÃ§Ãµes do prÃ©-cadastro</h5>
                    <label class="btn-close" [attr.for]="'acoes-toggle-'+i.id" aria-label="Fechar"></label>
                  </div>

                  <div class="crn-modal__body">
                    <!-- Grupo principal -->
                    <div class="group-title">Geral</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-dark"
                        (click)="acToggle.checked = false; abrirEditar(i)">
                        <i class="bi bi-pencil me-1"></i> Editar
                      </button>

                      <button type="button" class="btn btn-outline-secondary"
                        (click)="acToggle.checked = false; abrirVer(i)">
                        <i class="bi bi-eye me-1"></i> Ver
                      </button>

                      <button type="button" class="btn btn-outline-danger" (click)="acToggle.checked=false; remover(i)">
                        <i class="bi bi-trash me-1"></i> Remover
                      </button>
                    </div>

                    <!-- ObservaÃ§Ãµes -->
                    <div class="group-title">ObservaÃ§Ãµes</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-primary"
                        (click)="acToggle.checked=false; abrirObservacoes(i)">
                        <i class="bi bi-journal-text me-1"></i> ObservaÃ§Ãµes
                      </button>
                    </div>

                    <!-- Arquivos -->
                    <div class="group-title">Arquivos</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-info"
                        (click)="acToggle.checked=false; abrirArquivos(i)">
                        <i class="bi bi-paperclip me-1"></i> Arquivos
                      </button>
                    </div>

                    <!-- Grupo visita -->
                    <div class="group-title">Visita</div>
                    <div class="actions-grid">
                      <a class="btn btn-outline-success" *ngIf="i.telefone" href=""
                        (click)="onWhatsClick($event, i.telefone, acToggle)">
                        <i class="bi bi-whatsapp me-1"></i> WhatsApp
                      </a>

                      <button type="button" class="btn btn-outline-secondary"
                        (click)="acToggle.checked=false; abrirAgendar(i)"
                        [disabled]="(i.agendamentoStatus||'nao_agendado')==='agendado'">
                        <i class="bi bi-calendar-plus me-1"></i>
                        {{ (i.agendamentoStatus||'nao_agendado')==='agendado' ? 'JÃ¡ agendado' : 'Marcar visita' }}
                      </button>
                      <button type="button" class="btn btn-outline-primary"
                        *ngIf="(i.agendamentoStatus||'nao_agendado')==='agendado'"
                        (click)="acToggle.checked=false; marcarVisitado(i)">
                        <i class="bi bi-check2-circle me-1"></i> Marcar visitado
                      </button>
                      <button type="button" class="btn btn-outline-danger"
                        *ngIf="(i.agendamentoStatus||'nao_agendado')==='agendado'"
                        (click)="acToggle.checked=false; cancelarAgendamento(i)">
                        <i class="bi bi-x-circle me-1"></i> Cancelar agendamento
                      </button>
                    </div>

                    <!-- Grupo formalizaÃ§Ã£o -->
                    <div class="group-title">FormalizaÃ§Ã£o</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-primary"
                        *ngIf="formalizacaoStatus(i) === 'nao_formalizado'"
                        (click)="acToggle.checked=false; marcarFormalizado(i)">
                        <i class="bi bi-file-check me-1"></i> Marcar formalizado
                      </button>
                      <button type="button" class="btn btn-outline-secondary"
                        *ngIf="formalizacaoStatus(i) === 'formalizado'"
                        (click)="acToggle.checked=false; desfazerFormalizacao(i)">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Desfazer formalizaÃ§Ã£o
                      </button>
                    </div>

                    <!-- Grupo desistÃªncia -->
                    <div class="group-title">DesistÃªncia</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-warning"
                        *ngIf="desistenciaStatus(i) === 'nao_desistiu'"
                        (click)="acToggle.checked=false; marcarDesistencia(i)">
                        <i class="bi bi-emoji-frown me-1"></i> Marcar desistÃªncia
                      </button>
                      <button type="button" class="btn btn-outline-dark" *ngIf="desistenciaStatus(i) === 'desistiu'"
                        (click)="acToggle.checked=false; desfazerDesistencia(i)">
                        <i class="bi bi-emoji-smile me-1"></i> Desfazer desistÃªncia
                      </button>
                    </div>
                  </div>

                  <div class="crn-modal__footer">
                    <label class="btn btn-light" [attr.for]="'acoes-toggle-'+i.id">Fechar</label>
                  </div>
                </div>
              </div>
              <!-- ===== /Toggle & Modal ===== -->

            </div>
          </div>
        </div>

        <div *ngIf="!pagedItems()?.length" class="text-center text-muted py-4">
          Nenhum registro encontrado para os filtros/busca.
        </div>
      </div>

      <!-- PaginaÃ§Ã£o Pessoas -->
      <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          PÃ¡gina {{ page() }} de {{ totalPages() }}
        </div>
        <div class="btn-group">
          <button class="btn btn-outline-secondary" (click)="goFirst()" [disabled]="page()===1">
            <i class="bi bi-chevron-double-left"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="goPrev()" [disabled]="page()===1">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="goNext()" [disabled]="page()===totalPages()">
            <i class="bi bi-chevron-right"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="goLast()" [disabled]="page()===totalPages()">
            <i class="bi bi-chevron-double-right"></i>
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- ======================= ABA: GRUPOS ======================= -->
  <ng-container *ngIf="aba()==='grupos'">

    <!-- Loading Grupos -->
    <div *ngIf="gruposLoading()" class="alert alert-light border-0 shadow-sm d-flex align-items-center gap-2">
      <span class="spinner-border spinner-border-sm"></span>
      Carregando gruposâ€¦
    </div>

    <!-- Grid de grupos -->
    <div class="card shadow-sm border-0" *ngIf="!gruposLoading()">
      <div class="card-body">

        <div *ngIf="!gruposPaged()?.length" class="text-center text-muted py-4">
          Nenhum grupo distribuÃ­do para vocÃª ainda.
        </div>

        <div class="row row-cols-1 row-cols-lg-2 g-3" *ngIf="gruposPaged()?.length">
          <div class="col" *ngFor="let g of gruposPaged()">
            <div class="crn-card h-100 d-flex flex-column">
              <!-- CabeÃ§alho do grupo -->
              <div class="crn-card__header d-flex align-items-center gap-3">
                <div class="avatar-inicial">
                  {{ (g.nome || '?').charAt(0) | uppercase }}
                </div>
                <div class="min-w-0">
                  <div class="fw-semibold truncate-2 mb-0 text-crn-dark">
                    {{ g.nome || 'Grupo sem nome' }}
                  </div>
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <small class="badge text-bg-light">ID: {{ g.id }}</small>
                    <small class="badge" [class.text-bg-secondary]="(g.status||'rascunho')==='rascunho'"
                      [class.text-bg-success]="(g.status||'rascunho')==='ativo'"
                      [class.text-bg-dark]="(g.status||'rascunho')==='fechado'"
                      [class.text-bg-danger]="(g.status||'rascunho')==='cancelado'">
                      Status: {{ g.status }}
                    </small>
                    <small class="badge" [class.text-bg-success]="g.situacao==='aprovado'"
                      [class.text-bg-warning]="g.situacao==='incompleto'"
                      [class.text-bg-danger]="g.situacao==='inapto'">
                      SituaÃ§Ã£o: {{ g.situacao }}
                    </small>
                  </div>
                </div>
              </div>

              <!-- Corpo do grupo -->
              <div class="crn-card__body">
                <!-- Linha 1: Cidade/UF, Capacidade, Quantidade -->
                <div class="row g-2 mb-2">
                  <div class="col-md-4">
                    <div class="crn-field">
                      <span class="crn-label">Cidade/UF</span>
                      <span class="crn-value">
                        {{ g.cidade || 'â€”' }}
                        <ng-container *ngIf="g.uf"> â€¢ {{ g.uf }}</ng-container>
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="crn-field">
                      <span class="crn-label">Capacidade</span>
                      <span class="crn-value">{{ g.capacidadeMin }}/{{ g.capacidadeMax }}</span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="crn-field">
                      <span class="crn-label">Membros</span>
                      <span class="crn-value">{{ g.membrosCount || g.membrosIds.length }}</span>
                    </div>
                  </div>
                </div>

                <!-- MÃ©tricas do grupo -->
                <div class="d-flex flex-wrap gap-2 mb-3" *ngIf="$any(g)?.metrics as mt">
                  <span class="badge text-bg-info">Agendados: {{ mt.agendados }}</span>
                  <span class="badge text-bg-success">Visitados: {{ mt.visitados }}</span>
                  <span class="badge text-bg-primary">Formalizados: {{ mt.formalizados }}</span>
                  <span class="badge text-bg-warning">Desistentes: {{ mt.desistentes }}</span>
                </div>

                <!-- Coordenador -->
                <div class="border rounded p-3 mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Coordenador</strong>
                    <a *ngIf="g.inviteUrl" [href]="g.inviteUrl" target="_blank" rel="noopener" class="small">
                      Link de convite <i class="bi bi-box-arrow-up-right ms-1"></i>
                    </a>
                  </div>

                  <ng-container *ngIf="$any(g)?.coordenadorView as c; else semCoord">
                    <div class="row g-2 align-items-center">
                      <div class="col-12 col-md-6">
                        <div class="text-truncate"><i class="bi bi-person me-1"></i> {{ c.nome || 'â€”' }}</div>
                        <div class="text-muted small">
                          CPF {{ c.cpf || 'â€”' }} â€¢ {{ c.telefone || 'sem telefone' }}
                        </div>
                        <div class="text-muted small">
                          {{ c.endereco || 'â€”' }} <ng-container *ngIf="c.bairro">â€” {{ c.bairro }}</ng-container>
                        </div>
                      </div>
                      <div class="col-12 col-md-6 text-md-end mt-2 mt-md-0">
                        <div class="btn-group btn-group-sm">
                          <a class="btn btn-outline-success" *ngIf="whatsHrefCoordenador(g)"
                            [href]="whatsHrefCoordenador(g)!" target="_blank" rel="noopener">
                            <i class="bi bi-whatsapp me-1"></i> Whats
                          </a>
                          <button class="btn btn-outline-secondary" (click)="abrirAgendarCoordenador(g)"
                            [disabled]="(c.agendamentoStatus||'nao_agendado')==='agendado'">
                            <i class="bi bi-calendar-plus me-1"></i>
                            {{ (c.agendamentoStatus||'nao_agendado')==='agendado' ? 'JÃ¡ agendado' : 'Agendar' }}
                          </button>
                          <button class="btn btn-outline-primary"
                            *ngIf="(c.agendamentoStatus||'nao_agendado')==='agendado'"
                            (click)="marcarVisitadoCoordenador(g)">
                            <i class="bi bi-check2-circle me-1"></i> Visitado
                          </button>
                          <button class="btn btn-outline-danger"
                            *ngIf="(c.agendamentoStatus||'nao_agendado')==='agendado'"
                            (click)="cancelarAgendamentoCoordenador(g)">
                            <i class="bi bi-x-circle me-1"></i> Cancelar
                          </button>
                        </div>

                        <div class="btn-group btn-group-sm mt-2">
                          <button class="btn btn-outline-primary" *ngIf="c?.formalizacao?.status!=='formalizado'"
                            (click)="marcarFormalizadoCoordenador(g)">
                            <i class="bi bi-file-check me-1"></i> Formalizar
                          </button>
                          <button class="btn btn-outline-secondary" *ngIf="c?.formalizacao?.status==='formalizado'"
                            (click)="desfazerFormalizacaoCoordenador(g)">
                            <i class="bi bi-arrow-counterclockwise me-1"></i> Desfazer
                          </button>

                          <button class="btn btn-outline-warning" *ngIf="c?.desistencia?.status!=='desistiu'"
                            (click)="marcarDesistenciaCoordenador(g)">
                            <i class="bi bi-emoji-frown me-1"></i> Desistiu
                          </button>
                          <button class="btn btn-outline-dark" *ngIf="c?.desistencia?.status==='desistiu'"
                            (click)="desfazerDesistenciaCoordenador(g)">
                            <i class="bi bi-emoji-smile me-1"></i> Reativar
                          </button>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                  <ng-template #semCoord>
                    <div class="text-muted">Nenhum coordenador definido.</div>
                  </ng-template>
                </div>

              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- PaginaÃ§Ã£o Grupos -->
      <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          PÃ¡gina {{ pageGrupos() }} de {{ gruposTotalPages() }}
        </div>
        <div class="btn-group">
          <button class="btn btn-outline-secondary" (click)="gruposGoFirst()" [disabled]="pageGrupos()===1">
            <i class="bi bi-chevron-double-left"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="gruposGoPrev()" [disabled]="pageGrupos()===1">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="gruposGoNext()"
            [disabled]="pageGrupos()===gruposTotalPages()">
            <i class="bi bi-chevron-right"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="gruposGoLast()"
            [disabled]="pageGrupos()===gruposTotalPages()">
            <i class="bi bi-chevron-double-right"></i>
          </button>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<!-- ===== MODAL: EDITAR ===== -->
<div *ngIf="modalEditarAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalEditarTitulo">
    <div class="crn-modal__header">
      <h5 id="modalEditarTitulo" class="mb-0">Editar PrÃ©-cadastro</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="editModel() as m">
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label">Nome completo</label>
          <input class="form-control" [ngModel]="m.nomeCompleto"
            (ngModelChange)="onEditChange('nomeCompleto', $event)" />
        </div>
        <div class="col-md-4">
          <label class="form-label">CPF</label>
          <input class="form-control" [ngModel]="m.cpf" (ngModelChange)="onEditChange('cpf', $event)" />
        </div>

        <div class="col-md-4">
          <label class="form-label">Telefone</label>
          <input class="form-control" [ngModel]="m.telefone" (ngModelChange)="onEditChange('telefone', $event)" />
        </div>
        <div class="col-md-8">
          <label class="form-label">E-mail</label>
          <input type="email" class="form-control" [ngModel]="m.email"
            (ngModelChange)="onEditChange('email', $event)" />
        </div>

        <div class="col-md-8">
          <label class="form-label">EndereÃ§o</label>
          <input class="form-control" [ngModel]="m.endereco" (ngModelChange)="onEditChange('endereco', $event)" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Bairro</label>
          <input class="form-control" [ngModel]="m.bairro" (ngModelChange)="onEditChange('bairro', $event)" />
        </div>

        <div class="col-md-8">
          <label class="form-label">Cidade</label>
          <input class="form-control" [ngModel]="m.cidade" (ngModelChange)="onEditChange('cidade', $event)" />
        </div>
        <div class="col-md-4">
          <label class="form-label">UF</label>
          <input class="form-control text-uppercase" maxlength="2" [ngModel]="m.uf"
            (ngModelChange)="onEditChange('uf', ($event || '').toUpperCase())" />
        </div>
      </div>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Cancelar</button>
      <button class="btn btn-success" (click)="salvarEdicao()" [disabled]="saving()">
        <i class="bi bi-check2 me-1"></i> Salvar alteraÃ§Ãµes
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL: AGENDAR VISITA ===== -->
<div *ngIf="modalAgendarAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalAgendarTitulo">
    <div class="crn-modal__header">
      <h5 id="modalAgendarTitulo" class="mb-0">Agendar visita</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="itemAgendar() as a">
      <p class="mb-3">
        <strong>Cliente:</strong> {{ a.nomeCompleto }} <br>
        <small class="text-muted">CPF {{ a.cpf || 'â€”' }} â€¢ {{ a.telefone || 'sem telefone' }}</small>
      </p>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Data</label>
          <input type="date" class="form-control" [(ngModel)]="agData" />
        </div>
        <div class="col-md-6">
          <label class="form-label">HorÃ¡rio</label>
          <input type="time" class="form-control" [(ngModel)]="agHora" />
        </div>
      </div>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Cancelar</button>
      <button class="btn btn-success" (click)="salvarAgendamento()" [disabled]="agSalvando()">
        <i class="bi bi-check2 me-1"></i> Salvar agendamento
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL: VER (visualizaÃ§Ã£o completa) ===== -->
<div *ngIf="modalVerAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalVerTitulo">
    <div class="crn-modal__header">
      <h5 id="modalVerTitulo" class="mb-0">PrÃ©-cadastro â€” VisualizaÃ§Ã£o</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="viewItem() as v">
      <div class="row g-3">
        <div class="col-md-6"><strong>Nome:</strong>
          <div>{{ v.nomeCompleto || 'â€”' }}</div>
        </div>
        <div class="col-md-3"><strong>CPF:</strong>
          <div>{{ v.cpf || 'â€”' }}</div>
        </div>
        <div class="col-md-3"><strong>Telefone:</strong>
          <div>{{ v.telefone || 'â€”' }}</div>
        </div>

        <div class="col-md-6"><strong>E-mail:</strong>
          <div>{{ v.email || 'â€”' }}</div>
        </div>
        <div class="col-md-6"><strong>Origem:</strong>
          <div>{{ v.origem || 'â€”' }}</div>
        </div>

        <div class="col-md-8"><strong>EndereÃ§o:</strong>
          <div class="text-break">{{ v.endereco || 'â€”' }}</div>
        </div>
        <div class="col-md-2"><strong>Bairro:</strong>
          <div>{{ v.bairro || 'â€”' }}</div>
        </div>
        <div class="col-md-2"><strong>Cidade/UF:</strong>
          <div>{{ v.cidade || 'â€”' }} / {{ v.uf || 'â€”' }}</div>
        </div>

        <!-- ðŸ”Ž IndicaÃ§Ã£o de Grupo tambÃ©m no modal Ver -->
        <div class="col-12" *ngIf="v.grupoId">
          <strong>Grupo:</strong>
          <div>
            <span class="badge text-bg-success me-2">
              {{ ($any(v).grupoNome || (v.papelNoGrupo==='coordenador' ? 'Coordenador' : 'Membro')) }}
            </span>
            <small class="text-muted">ID {{ v.grupoId }}</small>
          </div>
        </div>

        <div class="col-12" *ngIf="v.observacoes">
          <strong>ObservaÃ§Ãµes:</strong>
          <div class="text-break">{{ v.observacoes }}</div>
        </div>

        <div class="col-12">
          <strong>Status:</strong>
          <div class="d-flex flex-wrap gap-2 mt-1">
            <span class="badge" [ngClass]="{
                'text-bg-secondary': (v.agendamentoStatus||'nao_agendado')==='nao_agendado',
                'text-bg-info': (v.agendamentoStatus||'nao_agendado')==='agendado',
                'text-bg-success': (v.agendamentoStatus||'nao_agendado')==='visitado'
              }">
              Agendamento: {{
              (v.agendamentoStatus||'nao_agendado')==='nao_agendado' ? 'NÃ£o agendado' :
              (v.agendamentoStatus||'nao_agendado')==='agendado' ? 'Agendado' : 'Visitado'
              }}
            </span>

            <span class="badge" [ngClass]="{
                'text-bg-secondary': (v.aprovacao?.status || 'nao_verificado')==='nao_verificado',
                'text-bg-danger': (v.aprovacao?.status || 'nao_verificado')==='inapto',
                'text-bg-success': (v.aprovacao?.status || 'nao_verificado')==='apto'
              }">
              AprovaÃ§Ã£o: {{
              (v.aprovacao?.status || 'nao_verificado')==='nao_verificado' ? 'NÃ£o verificado' :
              (v.aprovacao?.status==='apto' ? 'Apto' : 'Inapto')
              }}
            </span>

            <span class="badge" [ngClass]="formalizacaoBadgeClass(v)">
              {{ formalizacaoStatus(v) === 'formalizado' ? 'Formalizado' : 'NÃ£o formalizado' }}
            </span>

            <span class="badge" [ngClass]="desistenciaBadgeClass(v)">
              {{ desistenciaStatus(v) === 'desistiu' ? 'Desistiu' : 'NÃ£o desistiu' }}
            </span>
          </div>
        </div>

      </div>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Fechar</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: OBSERVAÃ‡Ã•ES ===== -->
<div *ngIf="modalObsAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalObsTitulo">
    <div class="crn-modal__header">
      <h5 id="modalObsTitulo" class="mb-0">ObservaÃ§Ãµes do PrÃ©-cadastro</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="viewItem() as v">
      <div class="mb-2 text-muted">
        Cliente: <strong>{{ v.nomeCompleto || 'â€”' }}</strong>
      </div>
      <textarea class="form-control" rows="8" placeholder="Escreva observaÃ§Ãµes adicionaisâ€¦" [ngModel]="obsModel()"
        (ngModelChange)="obsModel.set($event)"></textarea>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Cancelar</button>
      <button class="btn btn-primary" (click)="salvarObservacoes()">
        <i class="bi bi-save me-1"></i> Salvar observaÃ§Ãµes
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL: ARQUIVOS ===== -->
<div *ngIf="modalArqsAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalArqsTitulo">
    <div class="crn-modal__header">
      <h5 id="modalArqsTitulo" class="mb-0">Arquivos do PrÃ©-cadastro</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="viewItem() as v">
      <div class="mb-2 text-muted">
        Cliente: <strong>{{ v.nomeCompleto || 'â€”' }}</strong>
      </div>

      <div class="d-flex align-items-center gap-2 mb-3">
        <input type="file" class="form-control" (change)="onEscolherArquivo($event)" [disabled]="uploadEmProgresso()" />
        <span *ngIf="uploadEmProgresso()" class="spinner-border spinner-border-sm" aria-label="Enviando..."></span>
      </div>

      <div *ngIf="arqsCarregando()" class="alert alert-light border-0 d-flex align-items-center gap-2">
        <span class="spinner-border spinner-border-sm"></span> Carregando arquivosâ€¦
      </div>

      <div *ngIf="!arqsCarregando() && !arqsLista()?.length" class="text-muted">
        Nenhum arquivo enviado ainda.
      </div>

      <ul class="list-group" *ngIf="!arqsCarregando() && arqsLista()?.length">
        <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let a of arqsLista()">
          <div class="me-3">
            <i class="bi bi-file-earmark me-2"></i>
            <a [href]="a.url" target="_blank" rel="noopener">{{ a.nome }}</a>
            <small class="text-muted ms-2" *ngIf="a.tamanho">({{ a.tamanho }} bytes)</small>
          </div>
          <div class="text-nowrap">
            <a class="btn btn-sm btn-outline-secondary me-1" [href]="a.url" download>
              <i class="bi bi-download"></i>
            </a>
            <button class="btn btn-sm btn-outline-danger" (click)="removerArquivo(a)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </li>
      </ul>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Fechar</button>
    </div>
  </div>
</div>
