<app-header></app-header>

<br><br><br><br><br><br>

<div class="container pre-cadastros-view">

  <!-- ✅ Toast de feedback -->
  <div *ngIf="toastVisivel()" class="alert alert-success shadow-sm border-0">
    Status atualizado com sucesso!
  </div>

  <!-- Header / Hero -->
  <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <div class="crn-kicker"></div>
      <div>
        <h3 class="mb-0 text-crn-dark fw-bold">Minha Lista</h3>
        <div class="mt-1 d-flex align-items-center gap-2 flex-wrap">
          <span class="text-muted" style="font-size:.9rem">Visualize seus atendimentos por Pessoas ou por Grupos</span>
          <br><br>
        </div>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a routerLink="/pre-cadastro/novo" class="btn btn-principal">
        <i class="bi bi-plus-lg me-1"></i> Novo
      </a>
      <a routerLink="/agendamentos" class="btn btn-outline-success">
        <i class="bi bi-calendar2-week me-1"></i> Meus agendamentos
      </a>
    </div>
  </div>

  <!-- ===== Abas Pessoas | Grupos ===== -->
  <div class="mt-3">
    <div class="btn-group" role="tablist" aria-label="Alternar visão">
      <button type="button" class="btn" [class.btn-success]="aba()==='pessoas'"
        [class.btn-outline-success]="aba()!=='pessoas'" (click)="setAba('pessoas')" role="tab"
        [attr.aria-selected]="aba()==='pessoas' ? 'true' : 'false'">
        <i class="bi bi-person-lines-fill me-1"></i> Pessoas
      </button>

      <button type="button" class="btn" [class.btn-success]="aba()==='grupos'"
        [class.btn-outline-success]="aba()!=='grupos'" (click)="setAba('grupos')" role="tab"
        [attr.aria-selected]="aba()==='grupos' ? 'true' : 'false'">
        <i class="bi bi-people-fill me-1"></i> Grupos
      </button>
    </div>
  </div>

  <!-- ======================= ABA: PESSOAS ======================= -->
  <ng-container *ngIf="aba()==='pessoas'">

    <!-- Toolbar: Busca + Filtros -->
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body py-3">

        <!-- Linha 1: busca + grupo + resumo -->
        <div class="row g-3 align-items-end">

          <!-- Busca -->
          <div class="col-12 col-md-6">
            <label class="form-label mb-1">Buscar por nome</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="search" class="form-control" placeholder="Digite o nome do cliente…" [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event)" />
            </div>
          </div>

          <!-- Grupo Solidário -->
          <div class="col-12 col-md-4">
            <label class="form-label mb-1">Grupo solidário</label>
            <select class="form-select" [ngModel]="filtroGrupo()" (ngModelChange)="filtroGrupo.set($event)">
              <option value="todos">Todos</option>
              <option value="com_grupo">Com grupo</option>
              <option value="sem_grupo">Individuais</option>
            </select>
          </div>

          <!-- Resumo -->
          <div class="col-12 col-md-2 text-md-end">
            <label class="form-label mb-1 d-block">Resumo</label>
            <div class="mt-md-1">
              <span class="badge-soft me-2">Total: {{ totalGeral() }}</span>
              <span class="badge-soft">Filtrados: {{ totalFiltrado() }}</span>
            </div>
          </div>

        </div>

        <hr class="my-3">

        <!-- Linha 2: bairro + filtros rápidos -->
        <div class="row g-3 align-items-end">

          <!-- Bairro -->
          <div class="col-12 col-md-6">
            <label class="form-label mb-1">Bairro</label>
            <select class="form-select" [ngModel]="filtroBairro()" (ngModelChange)="filtroBairro.set($event)">
              <option value="">Todos os bairros</option>
              <option *ngFor="let b of bairrosDisponiveis()" [value]="b">
                {{ b }}
              </option>
            </select>
          </div>

          <!-- Filtros rápidos -->
          <div class="col-12 col-md-6">
            <label class="form-label mb-1 d-block">Filtros rápidos</label>

            <div class="d-flex flex-wrap gap-2">

              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="filtroFormalizados" [checked]="filtroFormalizados()"
                  (change)="filtroFormalizados.set($any($event.target).checked)">
                <label class="form-check-label" for="filtroFormalizados">
                  Formalizados
                </label>
              </div>

              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="filtroSomenteAgendados"
                  [checked]="filtroSomenteAgendados()"
                  (change)="filtroSomenteAgendados.set($any($event.target).checked)">
                <label class="form-check-label" for="filtroSomenteAgendados">
                  Agendados
                </label>
              </div>

              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="filtroSomenteVisitados"
                  [checked]="filtroSomenteVisitados()"
                  (change)="filtroSomenteVisitados.set($any($event.target).checked)">
                <label class="form-check-label" for="filtroSomenteVisitados">
                  Visitados
                </label>
              </div>

              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="filtroProximos"
                  [checked]="filtroProximosAgendamentos()"
                  (change)="filtroProximosAgendamentos.set($any($event.target).checked)">
                <label class="form-check-label" for="filtroProximos">
                  Próx. 7 dias
                </label>
              </div>

            </div>
          </div>

        </div>

      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading()" class="alert alert-light border-0 shadow-sm d-flex align-items-center gap-2">
      <span class="spinner-border spinner-border-sm"></span>
      Carregando…
    </div>

    <!-- Lista em cards (Pessoas) -->
    <div class="card shadow-sm border-0" *ngIf="!loading()">
      <div class="card-body">

        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
          <div class="col" *ngFor="let i of pagedItems()">
            <div class="crn-card h-100 d-flex flex-column" [class.crn-card--highlight]="i.id === highlightId()">

              <!-- Cabeçalho -->
              <div class="crn-card__header d-flex align-items-center gap-3">
                <div class="avatar-inicial">
                  {{ (i.nomeCompleto || '?').charAt(0) | uppercase }}
                </div>
                <div class="min-w-0">
                  <div class="fw-semibold truncate-2 mt-1 text-crn-dark">
                    {{ i.nomeCompleto || '—' }}
                  </div>
                  <div class="d-flex align-items-center gap-2 mt-1 flex-wrap">
                    <small class="text-muted">Pré-cadastro</small>
                    <ng-container *ngIf="i.grupoId">
                      <span class="badge text-bg-success" title="Pertence a um grupo">
                        Grupo:
                        {{ ($any(i).grupoNome || (i.papelNoGrupo==='coordenador' ? 'Coordenador' : 'Membro')) }}
                      </span>
                    </ng-container>
                  </div>
                </div>
              </div>

              <!-- Corpo -->
              <div class="crn-card__body">
                <div class="crn-field">
                  <span class="crn-label">CPF</span>
                  <span class="crn-value">
                    <span class="badge text-bg-light fw-medium">{{ i.cpf || '—' }}</span>
                  </span>
                </div>

                <div class="crn-field">
                  <span class="crn-label">Telefone</span>
                  <span class="crn-value">
                    <i class="bi bi-telephone text-crn me-1"></i> {{ i.telefone || '—' }}
                  </span>
                </div>

                <div class="crn-field">
                  <span class="crn-label">Endereço</span>
                  <span class="crn-value text-break">{{ i.endereco || '—' }}</span>
                </div>

                <div class="crn-field">
                  <span class="crn-label">Bairro</span>
                  <span class="crn-value text-break">{{ i.bairro || '—' }}</span>
                </div>

                <!-- Cidade/UF + bandeira -->
                <div class="crn-field">
                  <span class="crn-label">Cidade/UF</span>
                  <span class="crn-value d-flex align-items-center gap-2">
                    <span class="text-break">
                      {{ (i.cidade || '—') }}
                      <ng-container *ngIf="i.uf; else noUF">
                        • <span class="uf-text">{{ i.uf.toUpperCase() }}</span>
                      </ng-container>
                      <ng-template #noUF></ng-template>
                    </span>
                    <span *ngIf="i.uf" class="uf-flag" [ngClass]="
                            (i.uf.toLowerCase()==='pa') ? 'flag-pa' :
                            (i.uf.toLowerCase()==='am') ? 'flag-am' :
                            (i.uf.toLowerCase()==='ap') ? 'flag-ap' : 'flag-br'
                          " [title]="'Bandeira ' + (i.uf.toUpperCase() || 'BR')" aria-hidden="true"></span>
                  </span>
                </div>

                <!-- Aprovação -->
                <div class="crn-field">
                  <span class="crn-label">Aprovação</span>
                  <span class="crn-value">
                    <span class="badge" [ngClass]="{
                            'text-bg-secondary': (i.aprovacao?.status || 'nao_verificado')==='nao_verificado',
                            'text-bg-danger':    (i.aprovacao?.status || 'nao_verificado')==='inapto',
                            'text-bg-success':   (i.aprovacao?.status || 'nao_verificado')==='apto'
                          }">
                      {{
                      (i.aprovacao?.status || 'nao_verificado')==='nao_verificado' ? 'Não verificado' :
                      (i.aprovacao?.status==='apto' ? 'Apto' : 'Inapto')
                      }}
                    </span>
                    <small class="text-muted ms-2" *ngIf="$any(i)?.aprovacao?.porNome">
                      por {{ $any(i).aprovacao.porNome }}
                      <ng-container *ngIf="$any(i)?.aprovacao?.em as em">
                        — {{ (em?.toDate ? em.toDate() : em) | date:'dd/MM/yyyy HH:mm' }}
                      </ng-container>
                    </small>
                  </span>
                </div>

                <!-- Encaminhado -->
                <div class="crn-field" *ngIf="encaminhadoParaMim(i)">
                  <span class="crn-label">Distribuído</span>
                  <span class="crn-value">
                    por {{ encaminhadoPorNome(i) || 'Analista' }}
                    <small class="text-muted" *ngIf="encaminhadoQuando(i)">
                      — {{ encaminhadoQuando(i) | date:'dd/MM/yyyy HH:mm' }}
                    </small>
                  </span>
                </div>

                <!-- Agendamento -->
                <div class="crn-field">
                  <span class="crn-label">Agendamento</span>
                  <span class="crn-value">
                    <span class="badge" [ngClass]="{
                            'text-bg-secondary': (i.agendamentoStatus || 'nao_agendado')==='nao_agendado',
                            'text-bg-info':      (i.agendamentoStatus || 'nao_agendado')==='agendado',
                            'text-bg-success':   (i.agendamentoStatus || 'nao_agendado')==='visitado'
                          }">
                      {{
                      (i.agendamentoStatus || 'nao_agendado') === 'nao_agendado' ? 'Não agendado' :
                      (i.agendamentoStatus || 'nao_agendado') === 'agendado' ? 'Agendado' : 'Visitado'
                      }}
                    </span>
                    <small class="text-muted ms-2" *ngIf="$any(i)?.agendamentoDataHora as ag">
                      {{ (ag?.toDate ? ag.toDate() : ag) | date:'dd/MM/yyyy HH:mm' }}
                    </small>
                  </span>
                </div>

                <!-- Formalização -->
                <div class="crn-field">
                  <span class="crn-label">Formalização</span>
                  <span class="crn-value">
                    <span class="badge" [ngClass]="formalizacaoBadgeClass(i)">
                      {{ formalizacaoStatus(i) === 'formalizado' ? 'Formalizado' : 'Não formalizado' }}
                    </span>
                    <small class="text-muted ms-2" *ngIf="$any(i)?.formalizacao?.porNome">
                      por {{ $any(i).formalizacao.porNome }}
                      <ng-container *ngIf="$any(i)?.formalizacao?.em as emFml">
                        — {{ (emFml?.toDate ? emFml.toDate() : emFml) | date:'dd/MM/yyyy HH:mm' }}
                      </ng-container>
                    </small>
                  </span>
                </div>

                <!-- Desistência -->
                <div class="crn-field">
                  <span class="crn-label">Desistência</span>
                  <span class="crn-value">
                    <span class="badge" [ngClass]="desistenciaBadgeClass(i)">
                      {{ desistenciaStatus(i) === 'desistiu' ? 'Desistiu' : 'Não desistiu' }}
                    </span>
                    <small class="text-muted ms-2" *ngIf="$any(i)?.desistencia?.porNome">
                      por {{ $any(i).desistencia.porNome }}
                      <ng-container *ngIf="$any(i)?.desistencia?.em as emDes">
                        — {{ (emDes?.toDate ? emDes.toDate() : emDes) | date:'dd/MM/yyyy HH:mm' }}
                      </ng-container>
                    </small>
                    <div class="text-muted mt-1" *ngIf="$any(i)?.desistencia?.observacao as obs">
                      <i class="bi bi-chat-left-quote me-1"></i>
                      <em>Obs.:</em> {{ obs }}
                    </div>
                  </span>
                </div>

                <!-- Observações (resumo) -->
                <div class="crn-field" *ngIf="i.observacoes">
                  <span class="crn-label">Observações</span>
                  <span class="crn-value text-break">
                    {{ i.observacoes }}
                  </span>
                </div>

              </div>

              <!-- ===== Toggle & Rodapé do card ===== -->
              <input type="checkbox" class="crn-actions-toggle" [attr.id]="'acoes-toggle-'+i.id" #acToggle
                aria-hidden="true" />

              <div class="crn-card__footer-actions">
                <label class="crn-actions-open" role="button" [attr.for]="'acoes-toggle-'+i.id"
                  [attr.aria-controls]="'acoes-modal-'+i.id" aria-expanded="false">
                  <i class="bi bi-list-task"></i>
                  <span class="crn-actions-open__label">Realizar uma ação</span>
                  <i class="bi bi-chevron-right ms-1"></i>
                </label>
              </div>

              <!-- Modal de ações do card (toggle por checkbox) -->
              <div class="crn-modal-toggle-target" [attr.id]="'acoes-modal-'+i.id" role="dialog" aria-modal="true"
                [attr.aria-labelledby]="'acoesTitulo-' + i.id">

                <label class="crn-modal__backdrop" [attr.for]="'acoes-toggle-'+i.id" aria-label="Fechar"></label>

                <div class="crn-modal__dialog">
                  <div class="crn-modal__header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0" [attr.id]="'acoesTitulo-' + i.id">Ações do pré-cadastro</h5>
                    <label class="btn-close" [attr.for]="'acoes-toggle-'+i.id" aria-label="Fechar"></label>
                  </div>

                  <div class="crn-modal__body">
                    <!-- Grupo principal -->
                    <div class="group-title">Geral</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-dark"
                        (click)="acToggle.checked = false; abrirEditar(i)">
                        <i class="bi bi-pencil me-1"></i> Editar
                      </button>

                      <button type="button" class="btn btn-outline-secondary"
                        (click)="acToggle.checked = false; abrirVer(i)">
                        <i class="bi bi-eye me-1"></i> Ver
                      </button>
                    </div>

                    <!-- Observações -->
                    <div class="group-title">Observações</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-primary"
                        (click)="acToggle.checked=false; abrirObservacoes(i)">
                        <i class="bi bi-journal-text me-1"></i> Observações
                      </button>
                    </div>

                    <!-- Arquivos -->
                    <div class="group-title">Arquivos</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-info"
                        (click)="acToggle.checked=false; abrirArquivos(i)">
                        <i class="bi bi-paperclip me-1"></i> Arquivos
                      </button>
                    </div>

                    <!-- Visita -->
                    <div class="group-title">Visita</div>
                    <div class="actions-grid">
                      <a class="btn btn-outline-success" *ngIf="i.telefone" href=""
                        (click)="onWhatsClick($event, i.telefone, acToggle)">
                        <i class="bi bi-whatsapp me-1"></i> WhatsApp
                      </a>

                      <button type="button" class="btn btn-outline-secondary"
                        (click)="acToggle.checked=false; abrirAgendar(i)"
                        [disabled]="(i.agendamentoStatus||'nao_agendado')==='agendado'">
                        <i class="bi bi-calendar-plus me-1"></i>
                        {{ (i.agendamentoStatus||'nao_agendado')==='agendado' ? 'Já agendado' : 'Marcar visita' }}
                      </button>

                      <button type="button" class="btn btn-outline-primary"
                        *ngIf="(i.agendamentoStatus||'nao_agendado')==='agendado'"
                        (click)="acToggle.checked=false; marcarVisitado(i)">
                        <i class="bi bi-check2-circle me-1"></i> Marcar visitado
                      </button>

                      <button type="button" class="btn btn-outline-danger"
                        *ngIf="(i.agendamentoStatus||'nao_agendado')==='agendado'"
                        (click)="acToggle.checked=false; cancelarAgendamento(i)">
                        <i class="bi bi-x-circle me-1"></i> Cancelar agendamento
                      </button>
                    </div>

                    <!-- Formalização -->
                    <div class="group-title">Formalização</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-primary"
                        *ngIf="formalizacaoStatus(i) === 'nao_formalizado'"
                        (click)="acToggle.checked=false; marcarFormalizado(i)">
                        <i class="bi bi-file-check me-1"></i> Marcar formalizado
                      </button>
                      <button type="button" class="btn btn-outline-secondary"
                        *ngIf="formalizacaoStatus(i) === 'formalizado'"
                        (click)="acToggle.checked=false; desfazerFormalizacao(i)">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Desfazer formalização
                      </button>
                    </div>

                    <!-- Desistência -->
                    <div class="group-title">Desistência</div>
                    <div class="actions-grid">
                      <button type="button" class="btn btn-outline-warning"
                        *ngIf="desistenciaStatus(i) === 'nao_desistiu'"
                        (click)="acToggle.checked=false; marcarDesistencia(i)">
                        <i class="bi bi-emoji-frown me-1"></i> Marcar desistência
                      </button>
                      <button type="button" class="btn btn-outline-dark" *ngIf="desistenciaStatus(i) === 'desistiu'"
                        (click)="acToggle.checked=false; desfazerDesistencia(i)">
                        <i class="bi bi-emoji-smile me-1"></i> Desfazer desistência
                      </button>
                    </div>
                  </div>

                  <div class="crn-modal__footer">
                    <label class="btn btn-light" [attr.for]="'acoes-toggle-'+i.id">Fechar</label>
                  </div>
                </div>
              </div>
              <!-- ===== /Toggle & Modal ===== -->

            </div>
          </div>
        </div>

        <div *ngIf="!pagedItems().length" class="text-center text-muted py-4">
          Nenhum registro encontrado para os filtros/busca.
        </div>
      </div>

      <!-- Paginação Pessoas -->
      <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          Página {{ page() }} de {{ totalPages() }}
        </div>
        <div class="btn-group">
          <button class="btn btn-outline-secondary" (click)="goFirst()" [disabled]="page()===1">
            <i class="bi bi-chevron-double-left"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="goPrev()" [disabled]="page()===1">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="goNext()" [disabled]="page()===totalPages()">
            <i class="bi bi-chevron-right"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="goLast()" [disabled]="page()===totalPages()">
            <i class="bi bi-chevron-double-right"></i>
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- ======================= ABA: GRUPOS ======================= -->
  <ng-container *ngIf="aba()==='grupos'">

    <!-- Loading Grupos -->
    <div *ngIf="gruposLoading()" class="alert alert-light border-0 shadow-sm d-flex align-items-center gap-2 mb-3">
      <span class="spinner-border spinner-border-sm"></span>
      Carregando grupos…
    </div>

    <!-- Grid de grupos -->
    <div class="card shadow-sm border-0" *ngIf="!gruposLoading()">
      <div class="card-body">

        <div *ngIf="!gruposPaged().length" class="text-center text-muted py-4">
          Nenhum grupo distribuído para você ainda.
        </div>

        <div class="row row-cols-1 row-cols-lg-2 g-3" *ngIf="gruposPaged().length">
          <div class="col" *ngFor="let g of gruposPaged()">
            <div class="crn-card h-100 d-flex flex-column">

              <!-- Cabeçalho do grupo -->
              <div class="crn-card__header d-flex align-items-center gap-3">
                <div class="avatar-inicial">
                  {{ (g.nome || '?').charAt(0) | uppercase }}
                </div>
                <div class="min-w-0">
                  <div class="fw-semibold truncate-2 mb-1 text-crn-dark">
                    {{ g.nome || 'Grupo sem nome' }}
                  </div>

                  <div class="d-flex flex-wrap align-items-center gap-2">
                    <!-- Status -->
                    <small class="badge" [class.text-bg-secondary]="(g.status||'rascunho')==='rascunho'"
                      [class.text-bg-success]="(g.status||'rascunho')==='ativo'"
                      [class.text-bg-dark]="(g.status||'rascunho')==='fechado'"
                      [class.text-bg-danger]="(g.status||'rascunho')==='cancelado'">
                      Status: {{ g.status || 'rascunho' }}
                    </small>

                    <!-- Situação -->
                    <small class="badge" [class.text-bg-success]="g.situacao==='aprovado'"
                      [class.text-bg-warning]="g.situacao==='incompleto'"
                      [class.text-bg-danger]="g.situacao==='inapto'">
                      Situação: {{ g.situacao || '—' }}
                    </small>

                    <!-- Cidade / UF -->
                    <small class="badge text-bg-light text-truncate">
                      <i class="bi bi-geo-alt me-1"></i>
                      {{ g.cidade || 'Cidade não informada' }}
                      <ng-container *ngIf="g.uf">/ {{ g.uf }}</ng-container>
                    </small>

                    <!-- Capacidade / Membros -->
                    <small class="badge text-bg-info">
                      {{ g.membrosCount || g.membrosIds.length || 0 }}
                      / {{ g.capacidadeMax || g.capacidadeMin || '?' }} membros
                    </small>
                  </div>
                </div>
              </div>

              <!-- Corpo do grupo -->
              <div class="crn-card__body mt-2">

                <!-- Métricas -->
                <div class="d-flex flex-wrap gap-2 mb-3" *ngIf="$any(g)?.metrics as mt">
                  <span class="badge text-bg-info">Agendados: {{ mt.agendados }}</span>
                  <span class="badge text-bg-success">Visitados: {{ mt.visitados }}</span>
                  <span class="badge text-bg-primary">Formalizados: {{ mt.formalizados }}</span>
                  <span class="badge text-bg-warning">Desistentes: {{ mt.desistentes }}</span>
                </div>

                <!-- Coordenador -->
                <div class="border rounded p-3 mb-2" *ngIf="$any(g)?.coordenadorView as c">
                  <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
                    <div class="min-w-0">
                      <div class="fw-semibold text-truncate">
                        <i class="bi bi-person me-1"></i> Coordenador: {{ c.nome || '—' }}
                      </div>
                      <div class="text-muted small text-truncate">
                        CPF {{ c.cpf || '—' }} • {{ c.telefone || 'sem telefone' }}
                      </div>
                      <div class="text-muted small text-truncate">
                        {{ c.endereco || '—' }}
                        <ng-container *ngIf="c.bairro"> — {{ c.bairro }}</ng-container>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Botão para modal -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <button class="btn btn-md btn-outline-success" (click)="abrirGrupo(g)">
                    <i class="bi bi-people-fill me-1"></i>
                    Visualizar Todos os Membros
                  </button>
                </div>

              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Paginação Grupos -->
      <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          Página {{ pageGrupos() }} de {{ gruposTotalPages() }}
        </div>
        <div class="btn-group">
          <button class="btn btn-outline-secondary" (click)="gruposGoFirst()" [disabled]="pageGrupos()===1">
            <i class="bi bi-chevron-double-left"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="gruposGoPrev()" [disabled]="pageGrupos()===1">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="gruposGoNext()"
            [disabled]="pageGrupos()===gruposTotalPages()">
            <i class="bi bi-chevron-right"></i>
          </button>
          <button class="btn btn-outline-secondary" (click)="gruposGoLast()"
            [disabled]="pageGrupos()===gruposTotalPages()">
            <i class="bi bi-chevron-double-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ========== MODAL CUSTOM: DETALHES DO GRUPO + MEMBROS ========== -->
    <div class="crn-modal-overlay" *ngIf="modalGrupoAberto()">
      <div class="crn-modal-xl">

        <!-- HEADER -->
        <div class="crn-modal-header" *ngIf="grupoSelecionado() as gSel">
          <div>
            <h5 class="mb-1">
              <i class="bi bi-people-fill me-1"></i>
              {{ gSel.nome || 'Grupo sem nome' }}
            </h5>

            <div class="d-flex flex-wrap gap-2 align-items-center">

              <!-- Status -->
              <span class="badge" [class.text-bg-secondary]="(gSel.status||'rascunho')==='rascunho'"
                [class.text-bg-success]="(gSel.status||'rascunho')==='ativo'"
                [class.text-bg-dark]="(gSel.status||'rascunho')==='fechado'"
                [class.text-bg-danger]="(gSel.status||'rascunho')==='cancelado'">
                Status: {{ gSel.status || 'rascunho' }}
              </span>

              <!-- Situação -->
              <span class="badge" [class.text-bg-success]="gSel.situacao==='aprovado'"
                [class.text-bg-warning]="gSel.situacao==='incompleto'"
                [class.text-bg-danger]="gSel.situacao==='inapto'">
                Situação: {{ gSel.situacao || '—' }}
              </span>

              <!-- Cidade + UF + Bandeira -->
              <span class="badge text-bg-light d-flex align-items-center gap-1">
                <i class="bi bi-geo-alt"></i>
                {{ gSel.cidade || 'Cidade não informada' }}
                <ng-container *ngIf="gSel.uf">
                  /
                  <span class="uf-flag" [ngClass]="'flag-'+(gSel.uf.toLowerCase() || 'br')"></span>
                  <span class="uf-text ms-1">{{ gSel.uf }}</span>
                </ng-container>
              </span>

              <!-- Capacidade -->
              <span class="badge text-bg-info">
                {{ gSel.membrosCount || gSel.membrosIds.length || 0 }}
                / {{ gSel.capacidadeMax || gSel.capacidadeMin || '?' }} membros
              </span>

            </div>
          </div>

          <button type="button" class="btn-close" (click)="fecharModalGrupo()" aria-label="Fechar"></button>
        </div>

        <!-- BODY -->
        <div class="crn-modal-body" *ngIf="grupoSelecionado() as gSel">

          <!-- MÉTRICAS -->
          <div class="mb-3" *ngIf="$any(gSel)?.metrics as mt">
            <h6 class="mb-2">Resumo do grupo</h6>
            <div class="d-flex flex-wrap gap-2">
              <span class="badge text-bg-info">Agendados: {{ mt.agendados }}</span>
              <span class="badge text-bg-success">Visitados: {{ mt.visitados }}</span>
              <span class="badge text-bg-primary">Formalizados: {{ mt.formalizados }}</span>
              <span class="badge text-bg-warning">Desistentes: {{ mt.desistentes }}</span>
            </div>
          </div>

          <h6 class="mb-3">Membros do grupo</h6>

          <ng-container *ngIf="$any(gSel)?.membrosView?.length; else semMembros">

            <!-- coordenador para marcar chip -->
            <ng-container *ngIf="$any(gSel)?.coordenadorView as coord">

              <div class="row row-cols-1 row-cols-md-2 g-3">
                <div class="col" *ngFor="let m of $any(gSel).membrosView; let i = index">
                  <div class="border rounded p-3 h-100 d-flex flex-column">

                    <!-- HEADER DO CARD -->
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="avatar-inicial" [ngClass]="{'avatar-lg': coord?.preCadastroId === m.preCadastroId}">
                        {{ (m.nome || '?').charAt(0) | uppercase }}
                      </span>
                      <div class="min-w-0">
                        <div class="d-flex align-items-center gap-2">
                          <strong class="text-truncate d-block">{{ m.nome || 'Sem nome' }}</strong>

                          <!-- chip Coordenador -->
                          <span class="badge-soft" *ngIf="coord?.preCadastroId === m.preCadastroId">
                            Coordenador
                          </span>
                        </div>
                        <div class="text-muted small">
                          CPF {{ m.cpf || '—' }}
                        </div>
                      </div>
                    </div>

                    <!-- ENDEREÇO / LOCAL -->
                    <div class="text-muted small text-truncate mb-1">
                      {{ m.bairro || coord?.bairro || '—' }}

                      <ng-container *ngIf="m.cidade || gSel.cidade">
                        • {{ m.cidade || gSel.cidade }}
                      </ng-container>

                      <ng-container *ngIf="m.uf || gSel.uf">
                        •
                        <span class="uf-flag" [ngClass]="'flag-'+((m.uf || gSel.uf || 'br').toLowerCase())"></span>
                        <span class="uf-text ms-1">{{ m.uf || gSel.uf }}</span>
                      </ng-container>
                    </div>

                    <!-- TELEFONE -->
                    <div class="text-muted small mb-2">
                      <i class="bi bi-telephone me-1"></i>
                      {{ m.telefone || 'sem telefone' }}
                    </div>

                    <!-- BADGES -->
                    <div class="d-flex flex-wrap gap-2 mt-auto small">
                      <span class="badge"
                        [class.text-bg-secondary]="(m.agendamentoStatus||'nao_agendado')==='nao_agendado'"
                        [class.text-bg-primary]="m.agendamentoStatus==='agendado'"
                        [class.text-bg-success]="m.agendamentoStatus==='visitado'">
                        Agendamento: {{ m.agendamentoStatus || 'nao_agendado' }}
                      </span>

                      <span class="badge" [class.text-bg-success]="m?.formalizacao?.status==='formalizado'"
                        [class.text-bg-secondary]="m?.formalizacao?.status!=='formalizado'">
                        Formalização: {{ m?.formalizacao?.status || 'nao_formalizado' }}
                      </span>

                      <span class="badge" [class.text-bg-warning]="m?.desistencia?.status==='desistiu'"
                        [class.text-bg-secondary]="m?.desistencia?.status!=='desistiu'">
                        Situação: {{ m?.desistencia?.status || 'nao_desistiu' }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

            </ng-container>
          </ng-container>

          <ng-template #semMembros>
            <div class="text-muted small">
              Nenhum membro cadastrado neste grupo ainda.
            </div>
          </ng-template>

        </div>

        <!-- FOOTER -->
        <div class="crn-modal-footer">
          <button class="btn btn-secondary" (click)="fecharModalGrupo()">Fechar</button>
        </div>

      </div>
    </div>

  </ng-container>

</div>

<!-- ===== MODAL: EDITAR ===== -->
<div *ngIf="modalEditarAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalEditarTitulo">
    <div class="crn-modal__header">
      <h5 id="modalEditarTitulo" class="mb-0">Editar Pré-cadastro</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="editModel() as m">
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label">Nome completo</label>
          <input class="form-control" [ngModel]="m.nomeCompleto"
            (ngModelChange)="onEditChange('nomeCompleto', $event)" />
        </div>
        <div class="col-md-4">
          <label class="form-label">CPF</label>
          <input class="form-control" [ngModel]="m.cpf" (ngModelChange)="onEditChange('cpf', $event)" />
        </div>

        <div class="col-md-4">
          <label class="form-label">Telefone</label>
          <input class="form-control" [ngModel]="m.telefone" (ngModelChange)="onEditChange('telefone', $event)" />
        </div>
        <div class="col-md-8">
          <label class="form-label">E-mail</label>
          <input type="email" class="form-control" [ngModel]="m.email"
            (ngModelChange)="onEditChange('email', $event)" />
        </div>

        <div class="col-md-8">
          <label class="form-label">Endereço</label>
          <input class="form-control" [ngModel]="m.endereco" (ngModelChange)="onEditChange('endereco', $event)" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Bairro</label>
          <input class="form-control" [ngModel]="m.bairro" (ngModelChange)="onEditChange('bairro', $event)" />
        </div>

        <div class="col-md-8">
          <label class="form-label">Cidade</label>
          <input class="form-control" [ngModel]="m.cidade" (ngModelChange)="onEditChange('cidade', $event)" />
        </div>
        <div class="col-md-4">
          <label class="form-label">UF</label>
          <input class="form-control text-uppercase" maxlength="2" [ngModel]="m.uf"
            (ngModelChange)="onEditChange('uf', ($event || '').toUpperCase())" />
        </div>
      </div>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Cancelar</button>
      <button class="btn btn-success" (click)="salvarEdicao()" [disabled]="saving()">
        <i class="bi bi-check2 me-1"></i> Salvar alterações
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL: AGENDAR VISITA ===== -->
<div *ngIf="modalAgendarAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalAgendarTitulo">
    <div class="crn-modal__header">
      <h5 id="modalAgendarTitulo" class="mb-0">Agendar visita</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="itemAgendar() as a">
      <p class="mb-3">
        <strong>Cliente:</strong> {{ a.nomeCompleto }} <br>
        <small class="text-muted">
          CPF {{ a.cpf || '—' }} • {{ a.telefone || 'sem telefone' }}
        </small>
      </p>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Data</label>
          <input type="date" class="form-control" [(ngModel)]="agData" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Horário</label>
          <input type="time" class="form-control" [(ngModel)]="agHora" />
        </div>
      </div>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Cancelar</button>
      <button class="btn btn-success" (click)="salvarAgendamento()" [disabled]="agSalvando()">
        <i class="bi bi-check2 me-1"></i> Salvar agendamento
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL: VER (visualização completa) ===== -->
<div *ngIf="modalVerAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalVerTitulo">
    <div class="crn-modal__header">
      <h5 id="modalVerTitulo" class="mb-0">Pré-cadastro — Visualização</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="viewItem() as v">
      <div class="row g-3">
        <div class="col-md-6">
          <strong>Nome:</strong>
          <div>{{ v.nomeCompleto || '—' }}</div>
        </div>
        <div class="col-md-3">
          <strong>CPF:</strong>
          <div>{{ v.cpf || '—' }}</div>
        </div>
        <div class="col-md-3">
          <strong>Telefone:</strong>
          <div>{{ v.telefone || '—' }}</div>
        </div>

        <div class="col-md-6">
          <strong>E-mail:</strong>
          <div>{{ v.email || '—' }}</div>
        </div>
        <div class="col-md-6">
          <strong>Origem:</strong>
          <div>{{ v.origem || '—' }}</div>
        </div>

        <div class="col-md-8">
          <strong>Endereço:</strong>
          <div class="text-break">{{ v.endereco || '—' }}</div>
        </div>
        <div class="col-md-2">
          <strong>Bairro:</strong>
          <div>{{ v.bairro || '—' }}</div>
        </div>
        <div class="col-md-2">
          <strong>Cidade/UF:</strong>
          <div>{{ v.cidade || '—' }} / {{ v.uf || '—' }}</div>
        </div>

        <!-- Indicação de Grupo -->
        <div class="col-12" *ngIf="v.grupoId">
          <strong>Grupo:</strong>
          <div>
            <span class="badge text-bg-success me-2">
              {{ ($any(v).grupoNome || (v.papelNoGrupo==='coordenador' ? 'Coordenador' : 'Membro')) }}
            </span>
            <small class="text-muted">ID {{ v.grupoId }}</small>
          </div>
        </div>

        <div class="col-12" *ngIf="v.observacoes">
          <strong>Observações:</strong>
          <div class="text-break">{{ v.observacoes }}</div>
        </div>

        <div class="col-12">
          <strong>Status:</strong>
          <div class="d-flex flex-wrap gap-2 mt-1">
            <span class="badge" [ngClass]="{
                    'text-bg-secondary': (v.agendamentoStatus||'nao_agendado')==='nao_agendado',
                    'text-bg-info': (v.agendamentoStatus||'nao_agendado')==='agendado',
                    'text-bg-success': (v.agendamentoStatus||'nao_agendado')==='visitado'
                  }">
              Agendamento:
              {{
              (v.agendamentoStatus||'nao_agendado')==='nao_agendado' ? 'Não agendado' :
              (v.agendamentoStatus||'nao_agendado')==='agendado' ? 'Agendado' : 'Visitado'
              }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL: OBSERVAÇÕES (EDIÇÃO) ===== -->
<div *ngIf="modalObsAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalObsTitulo">
    <div class="crn-modal__header">
      <h5 id="modalObsTitulo" class="mb-0">Observações do pré-cadastro</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="viewItem() as v">
      <p class="mb-2">
        <strong>Cliente:</strong> {{ v.nomeCompleto || '—' }}<br>
        <small class="text-muted">CPF {{ v.cpf || '—' }}</small>
      </p>

      <div class="mb-3">
        <label class="form-label">Observações</label>
        <textarea class="form-control" rows="5" [ngModel]="obsModel()"
          (ngModelChange)="obsModel.set($event)"></textarea>
      </div>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Cancelar</button>
      <button class="btn btn-success" (click)="salvarObservacoes()">
        <i class="bi bi-check2 me-1"></i> Salvar observações
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL: ARQUIVOS / ANEXOS ===== -->
<div *ngIf="modalArqsAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalArqsTitulo">
    <div class="crn-modal__header">
      <h5 id="modalArqsTitulo" class="mb-0">Arquivos do pré-cadastro</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="viewItem() as v">
      <p class="mb-3">
        <strong>Cliente:</strong> {{ v.nomeCompleto || '—' }}<br>
        <small class="text-muted">
          CPF {{ v.cpf || '—' }} • {{ v.telefone || 'sem telefone' }}
        </small>
      </p>

      <!-- Upload -->
      <div class="mb-3">
        <label class="form-label">Adicionar arquivo</label>
        <input type="file" class="form-control" (change)="onEscolherArquivo($event)" [disabled]="uploadEmProgresso()" />
        <small class="text-muted d-block mt-1" *ngIf="uploadEmProgresso()">
          Enviando arquivo… aguarde.
        </small>
      </div>

      <hr>

      <!-- Lista de arquivos -->
      <div *ngIf="arqsCarregando()" class="text-muted d-flex align-items-center gap-2 mb-2">
        <span class="spinner-border spinner-border-sm"></span>
        Carregando arquivos…
      </div>

      <div *ngIf="!arqsCarregando() && !arqsLista().length" class="text-muted">
        Nenhum arquivo anexado ainda.
      </div>

      <div class="list-group" *ngIf="!arqsCarregando() && arqsLista().length">
        <div class="list-group-item d-flex justify-content-between align-items-start gap-2"
          *ngFor="let arq of arqsLista()">
          <div class="me-2">
            <div class="fw-semibold">
              <a [href]="arq.url" target="_blank" rel="noopener noreferrer">
                <i class="bi bi-paperclip me-1"></i> {{ arq.nome || 'Arquivo' }}
              </a>
            </div>
            <div class="text-muted small">
              <ng-container *ngIf="$any(arq)?.contentType">
                {{ $any(arq).contentType }} •
              </ng-container>
              <ng-container *ngIf="$any(arq)?.tamanhoBytes as tb">
                {{ tb / 1024 | number:'1.0-0' }} KB
              </ng-container>
              <ng-container *ngIf="$any(arq)?.criadoEm as ts">
                • {{ (ts?.toDate ? ts.toDate() : ts) | date:'dd/MM/yyyy HH:mm' }}
              </ng-container>
            </div>
            <div class="text-muted small" *ngIf="$any(arq)?.subidoPorNome">
              Enviado por {{ $any(arq).subidoPorNome }}
            </div>
          </div>

          <div class="text-end">
            <button type="button" class="btn btn-sm btn-outline-danger" (click)="removerArquivo(arq)"
              [disabled]="uploadEmProgresso() || arqsCarregando()">
              <i class="bi bi-trash me-1"></i> Remover
            </button>
          </div>
        </div>
      </div>

    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Fechar</button>
    </div>
  </div>
</div>