<app-header></app-header>

<br><br><br><br><br><br>

<div class="container pre-cadastros-view">

  <!-- ✅ Toast de feedback -->
  <div *ngIf="toastVisivel()" class="alert alert-success shadow-sm border-0">
    Status atualizado com sucesso!
  </div>

  <!-- Header / Hero -->
  <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <div class="crn-kicker"></div>
      <div>
        <h3 class="mb-0 text-crn-dark fw-bold">Meus Pré-cadastros</h3>
        <div class="mt-1 d-flex align-items-center gap-2">
          <span class="badge-soft">Total: {{ itens().length }}</span>
          <span class="text-muted" style="font-size:.9rem">Visão geral dos seus cadastros recentes</span>
          <br><br>
        </div>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a routerLink="/pre-cadastro/novo" class="btn btn-principal">
        <i class="bi bi-plus-lg me-1"></i> Novo
      </a>
      <a routerLink="/agendamentos" class="btn btn-outline-success">
        <i class="bi bi-calendar2-week me-1"></i> Meus agendamentos
      </a>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body py-3">
      <div class="row g-2 align-items-center">
        <div class="col-12">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="search" class="form-control" placeholder="Buscar por nome, CPF, e-mail…">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="alert alert-light border-0 shadow-sm d-flex align-items-center gap-2">
    <span class="spinner-border spinner-border-sm"></span>
    Carregando…
  </div>

  <!-- Lista em cards -->
  <div class="card shadow-sm border-0" *ngIf="!loading()">
    <div class="card-body">

      <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
        <div class="col" *ngFor="let i of itens()">
          <div class="crn-card h-100 d-flex flex-column" [class.crn-card--highlight]="i.id === highlightId()">
            <!-- Cabeçalho -->
            <div class="crn-card__header">
              <div class="avatar-inicial">
                {{ (i.nomeCompleto || '?').charAt(0) | uppercase }}
              </div>
              <div class="min-w-0">
                <div class="fw-semibold truncate-2 mb-0 text-crn-dark">
                  {{ i.nomeCompleto || '—' }}
                </div>
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted">Pré-cadastro</small>
                  <span class="badge-soft">CPF</span>
                </div>
              </div>
            </div>

            <!-- Corpo -->
            <div class="crn-card__body">
              <div class="crn-field">
                <span class="crn-label">CPF</span>
                <span class="crn-value"><span class="badge text-bg-light fw-medium">{{ i.cpf || '—' }}</span></span>
              </div>
              <div class="crn-field">
                <span class="crn-label">Telefone</span>
                <span class="crn-value"><i class="bi bi-telephone text-crn me-1"></i> {{ i.telefone || '—' }}</span>
              </div>
              <div class="crn-field">
                <span class="crn-label">E-mail</span>
                <span class="crn-value text-break"><i class="bi bi-envelope text-muted me-1"></i> {{ i.email || '—'
                  }}</span>
              </div>
              <div class="crn-field">
                <span class="crn-label">Endereço</span>
                <span class="crn-value text-break">{{ i.endereco || '—' }}</span>
              </div>
              <div class="crn-field">
                <span class="crn-label">Bairro</span>
                <span class="crn-value text-break">{{ i.bairro || '—' }}</span>
              </div>
              <div class="crn-field">
                <span class="crn-label">Criado em</span>
                <span class="crn-value">
                  {{ i.createdAt?.toDate ? (i.createdAt.toDate() | date:'dd/MM/yyyy HH:mm') : '—' }}
                </span>
              </div>

              <!-- Status de agendamento -->
              <div class="crn-field">
                <span class="crn-label">Agendamento</span>
                <span class="crn-value">
                  <span class="badge" [ngClass]="{
                      'text-bg-secondary': (i.agendamentoStatus || 'nao_agendado')==='nao_agendado',
                      'text-bg-info': (i.agendamentoStatus || 'nao_agendado')==='agendado',
                      'text-bg-success': (i.agendamentoStatus || 'nao_agendado')==='visitado'
                    }">
                    {{
                    (i.agendamentoStatus || 'nao_agendado') === 'nao_agendado' ? 'Não agendado' :
                    (i.agendamentoStatus || 'nao_agendado') === 'agendado' ? 'Agendado' : 'Visitado'
                    }}
                  </span>
                </span>
              </div>
            </div>

            <!-- Ações -->
            <div class="crn-card__actions mt-3 d-flex flex-column gap-3">
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary flex-fill" (click)="abrirVer(i)">
                  <i class="bi bi-eye me-1"></i> Ver
                </button>
                <button type="button" class="btn btn-outline-dark flex-fill" (click)="abrirEditar(i)">
                  <i class="bi bi-pencil me-1"></i> Editar
                </button>
                <button type="button" class="btn btn-outline-danger flex-fill" (click)="remover(i)">
                  <i class="bi bi-trash"></i>
                </button>
              </div>

              <div class="d-flex gap-2">
                <!-- 
                <button type="button" class="btn btn-success flex-fill" (click)="iniciarCadastro(i)">
                  <i class="bi bi-clipboard-check me-1"></i> Iniciar cadastro
                </button>
-->
                <a class="btn btn-outline-success flex-fill" *ngIf="i.telefone" [href]="whatsHref(i.telefone)"
                  target="_blank" rel="noopener">
                  <i class="bi bi-whatsapp me-1"></i> Entrar em contato
                </a>

                <button type="button" class="btn btn-outline-secondary flex-fill" (click)="abrirAgendar(i)"
                  [disabled]="(i.agendamentoStatus||'nao_agendado')==='agendado'" title="Criar agendamento de visita">
                  <i class="bi bi-calendar-plus me-1"></i>
                  {{ (i.agendamentoStatus||'nao_agendado')==='agendado' ? 'Já agendado' : 'Marcar visita' }}
                </button>
              </div>

              <div class="d-flex gap-2">

                <button type="button" class="btn btn-outline-primary flex-fill"
                  *ngIf="(i.agendamentoStatus||'nao_agendado')==='agendado'" (click)="marcarVisitado(i)">
                  <i class="bi bi-check2-circle me-1"></i> Marcar como visitado
                </button>

                <button type="button" class="btn btn-outline-danger flex-fill"
                  *ngIf="(i.agendamentoStatus||'nao_agendado')==='agendado'" (click)="cancelarAgendamento(i)">
                  <i class="bi bi-x-circle me-1"></i> Cancelar agendamento
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="!itens()?.length" class="text-center text-muted py-4">Nenhum registro ainda.</div>
    </div>
  </div>
</div>

<!-- ===== MODAL: VER ===== -->
<div *ngIf="modalVerAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalVerTitulo">
    <div class="crn-modal__header">
      <h5 id="modalVerTitulo" class="mb-0">Detalhes do Pré-cadastro</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>
    <div class="crn-modal__body" *ngIf="viewItem() as v">
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="avatar-inicial avatar-lg">
          {{ (v.nomeCompleto || '?').charAt(0) | uppercase }}
        </div>
        <div class="min-w-0">
          <div class="fw-semibold truncate-2 text-crn-dark">{{ v.nomeCompleto || '—' }}</div>
          <small class="text-muted">
            {{ v.createdAt?.toDate ? (v.createdAt.toDate() | date:'dd/MM/yyyy HH:mm') : '—' }}
          </small>
        </div>
      </div>

      <dl class="row mb-0">
        <dt class="col-sm-3">CPF</dt>
        <dd class="col-sm-9">{{ v.cpf || '—' }}</dd>
        <dt class="col-sm-3">Telefone</dt>
        <dd class="col-sm-9">{{ v.telefone || '—' }}</dd>
        <dt class="col-sm-3">E-mail</dt>
        <dd class="col-sm-9 text-break">{{ v.email || '—' }}</dd>
        <dt class="col-sm-3">Endereço</dt>
        <dd class="col-sm-9 text-break">{{ v.endereco || '—' }}</dd>
        <dt class="col-sm-3">Bairro</dt>
        <dd class="col-sm-9 text-break">{{ v.bairro || '—' }}</dd>
      </dl>
    </div>
    <div class="crn-modal__footer">
      <button class="btn btn-secondary" (click)="fecharModais()">Fechar</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: AGENDAR VISITA ===== -->
<div *ngIf="modalAgendarAberto()" class="crn-modal" role="dialog" aria-modal="true">
  <div class="crn-modal__backdrop" (click)="fecharModais()"></div>
  <div class="crn-modal__dialog" role="document" aria-labelledby="modalAgendarTitulo">
    <div class="crn-modal__header">
      <h5 id="modalAgendarTitulo" class="mb-0">Agendar visita</h5>
      <button class="btn-close" (click)="fecharModais()" aria-label="Fechar"></button>
    </div>

    <div class="crn-modal__body" *ngIf="itemAgendar() as a">
      <p class="mb-3">
        <strong>Cliente:</strong> {{ a.nomeCompleto }} <br>
        <small class="text-muted">CPF {{ a.cpf || '—' }} • {{ a.telefone || 'sem telefone' }}</small>
      </p>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Data</label>
          <input type="date" class="form-control" [(ngModel)]="agData" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Horário</label>
          <input type="time" class="form-control" [(ngModel)]="agHora" />
        </div>
      </div>
    </div>

    <div class="crn-modal__footer">
      <button class="btn btn-light" (click)="fecharModais()">Cancelar</button>
      <button class="btn btn-success" (click)="salvarAgendamento()" [disabled]="agSalvando()">
        <i class="bi bi-check2 me-1"></i> Salvar agendamento
      </button>
    </div>
  </div>
</div>