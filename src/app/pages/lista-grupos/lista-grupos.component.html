<app-header></app-header>
<br>

<div class="container py-5 mt-5">
  <!-- Título + ações -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 py-4">
    <h3 class="mb-0 fw-bold text-success">
      <i class="bi bi-people-fill me-2"></i>Grupos Solidários
    </h3>

    <div class="btn-group">
      <button class="btn btn-outline-secondary" [class.active]="visualizacao() === 'cards'" (click)="trocarVisualizacao('cards')">
        <i class="bi bi-grid-3x3-gap me-1"></i> Cards
      </button>
      <button class="btn btn-outline-secondary" [class.active]="visualizacao() === 'tabela'" (click)="trocarVisualizacao('tabela')">
        <i class="bi bi-table me-1"></i> Tabela
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="border rounded p-3 h-100">
        <div class="small text-muted">Total de grupos</div>
        <div class="fs-4 fw-bold">{{ kpiTotal() }}</div>
      </div>
    </div>
    <div class="col-6 col-md-9 d-flex align-items-center">
      <div class="text-muted small">
        {{ gruposFiltrados().length }} após filtros
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="border rounded p-3 mb-3">
    <div class="row g-2">
      <div class="col-12 col-md-3">
        <label class="form-label">Nome</label>
        <input class="form-control" [(ngModel)]="filtro().nome" (ngModelChange)="paginaAtual.set(1)" placeholder="Buscar por nome..." />
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Status</label>
        <select class="form-select" [(ngModel)]="filtro().status" (ngModelChange)="paginaAtual.set(1)">
          <option value="">Todos</option>
          <option *ngFor="let s of statusDisponiveis()" [value]="s">{{ s | titlecase }}</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Cidade</label>
        <select class="form-select" [(ngModel)]="filtro().cidade" (ngModelChange)="paginaAtual.set(1)">
          <option value="">Todas</option>
          <option *ngFor="let c of cidadesDisponiveis()" [value]="c">{{ c }}</option>
        </select>
      </div>

      <div class="col-6 col-md-1">
        <label class="form-label">UF</label>
        <select class="form-select" [(ngModel)]="filtro().uf" (ngModelChange)="paginaAtual.set(1)">
          <option value="">Todas</option>
          <option *ngFor="let u of ufsDisponiveis()" [value]="u">{{ u }}</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Coordenador</label>
        <select class="form-select" [(ngModel)]="filtro().coordenador" (ngModelChange)="paginaAtual.set(1)">
          <option value="">Todos</option>
          <option *ngFor="let a of coordenadoresDisponiveis()" [value]="a">{{ a }}</option>
        </select>
      </div>

      <div class="col-6 col-md-1">
        <label class="form-label">De</label>
        <input type="date" class="form-control" [(ngModel)]="filtro().criadoDe" (ngModelChange)="paginaAtual.set(1)" />
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label">Até</label>
        <input type="date" class="form-control" [(ngModel)]="filtro().criadoAte" (ngModelChange)="paginaAtual.set(1)" />
      </div>
    </div>
  </div>

  <!-- Loading / erro -->
  <div *ngIf="carregando()" class="alert alert-info">Carregando grupos...</div>
  <div *ngIf="!carregando() && erroCarregar()" class="alert alert-danger">{{ erroCarregar() }}</div>

  <!-- CARDS -->
  <div *ngIf="!carregando() && visualizacao() === 'cards'">
    <div class="row g-3">
      <div class="col-12 col-md-6 col-lg-4" *ngFor="let g of gruposPaginados(); trackBy: trackById">
        <div class="card h-100 shadow-sm">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="card-title mb-0">{{ g.nome }}</h5>
              <span class="badge {{ statusBadgeClass(g.status) }}">{{ g.status | titlecase }}</span>
            </div>

            <div class="small text-muted mb-2">
              Criado em: <strong>{{ toBRDate(g.criadoEm) }}</strong> às {{ toBRTime(g.criadoEm) }}
            </div>

            <div class="mb-2">
              <div class="small">Coordenador: <strong>{{ g.coordenadorNome ? (g.coordenadorNome | titlecase) : '—' }}</strong></div>
              <div class="small">Local: <strong>{{ g.cidade || '—' }}/{{ g.uf || '—' }}</strong></div>
              <div class="small">Membros: <strong>{{ g.membrosCount }}</strong> (capacidade {{ g.capacidadeMin }}–{{ g.capacidadeMax }})</div>
            </div>

            <div class="mt-auto d-flex gap-2">
              <button class="btn btn-outline-primary flex-fill" (click)="abrirModal(g)">
                <i class="bi bi-eye me-1"></i> Ver
              </button>
              <a class="btn btn-outline-dark flex-fill" [routerLink]="['/grupos', g.id]">
                <i class="bi bi-box-arrow-in-right me-1"></i> Abrir
              </a>
            </div>
          </div>

          <div class="card-footer d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-success" (click)="copyInvite(g)">
              <i class="bi bi-clipboard me-1"></i> Copiar convite
            </button>
            <button class="btn btn-sm btn-outline-success" (click)="shareWhatsApp(g)">
              <i class="bi bi-whatsapp me-1"></i> WhatsApp
            </button>
            <a class="btn btn-sm btn-outline-secondary ms-auto" [href]="g.inviteUrl" target="_blank" rel="noopener">
              <i class="bi bi-link-45deg me-1"></i> Abrir link
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginação -->
    <nav class="mt-3" *ngIf="totalPaginas() > 1">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="paginaAtual() === 1">
          <button class="page-link" (click)="irParaPagina(paginaAtual()-1)">Anterior</button>
        </li>
        <li class="page-item" *ngFor="let p of pages()" [class.active]="p === paginaAtual()">
          <button class="page-link" (click)="irParaPagina(p)">{{ p }}</button>
        </li>
        <li class="page-item" [class.disabled]="paginaAtual() === totalPaginas()">
          <button class="page-link" (click)="irParaPagina(paginaAtual()+1)">Próxima</button>
        </li>
      </ul>
    </nav>
  </div>

  <!-- TABELA -->
  <div *ngIf="!carregando() && visualizacao() === 'tabela'" class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th (click)="ordenarPor('nome')" role="button">Nome</th>
          <th (click)="ordenarPor('status')" role="button">Status</th>
          <th (click)="ordenarPor('cidade')" role="button">Cidade</th>
          <th (click)="ordenarPor('uf')" role="button">UF</th>
          <th (click)="ordenarPor('membrosCount')" role="button">Membros</th>
          <th (click)="ordenarPor('criadoEm')" role="button">Criado em</th>
          <th style="width: 220px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let g of gruposPaginados(); trackBy: trackById">
          <td class="fw-semibold">{{ g.nome }}</td>
          <td><span class="badge {{ statusBadgeClass(g.status) }}">{{ g.status | titlecase }}</span></td>
          <td>{{ g.cidade || '—' }}</td>
          <td>{{ g.uf || '—' }}</td>
          <td>{{ g.membrosCount }}</td>
          <td>{{ toBRDate(g.criadoEm) }} {{ toBRTime(g.criadoEm) }}</td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" (click)="abrirModal(g)">Ver</button>
              <a class="btn btn-sm btn-outline-dark" [routerLink]="['/grupos', g.id]">Abrir</a>
              <button class="btn btn-sm btn-outline-success" (click)="copyInvite(g)">Copiar link</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Paginação -->
    <nav class="mt-2" *ngIf="totalPaginas() > 1">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="paginaAtual() === 1">
          <button class="page-link" (click)="irParaPagina(paginaAtual()-1)">Anterior</button>
        </li>
        <li class="page-item" *ngFor="let p of pages()" [class.active]="p === paginaAtual()">
          <button class="page-link" (click)="irParaPagina(p)">{{ p }}</button>
        </li>
        <li class="page-item" [class.disabled]="paginaAtual() === totalPaginas()">
          <button class="page-link" (click)="irParaPagina(paginaAtual()+1)">Próxima</button>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- MODAL DETALHES -->
<div class="modal fade show" tabindex="-1" style="display:block; background: rgba(0,0,0,.35);" *ngIf="modalAberto()">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-people-fill me-2"></i>
          {{ grupoSelecionado()?.nome }}
        </h5>
        <button type="button" class="btn-close" (click)="fecharModal()"></button>
      </div>

      <div class="modal-body" *ngIf="grupoSelecionado() as g">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div><span class="text-muted">Status:</span>
              <span class="badge ms-1 {{ statusBadgeClass(g.status) }}">{{ g.status | titlecase }}</span>
            </div>
            <div><span class="text-muted">Criado em:</span> <strong>{{ toBRDate(g.criadoEm) }}</strong> {{ toBRTime(g.criadoEm) }}</div>
            <div><span class="text-muted">Coordenador:</span> <strong>{{ g.coordenadorNome || '—' }}</strong></div>
            <div><span class="text-muted">Local:</span> <strong>{{ g.cidade || '—' }}/{{ g.uf || '—' }}</strong></div>
          </div>
          <div class="col-12 col-md-6">
            <div><span class="text-muted">Capacidade:</span> <strong>{{ g.capacidadeMin }}–{{ g.capacidadeMax }}</strong></div>
            <div><span class="text-muted">Membros atuais:</span> <strong>{{ g.membrosCount }}</strong></div>
            <div class="text-truncate"><span class="text-muted">Convite:</span> <a [href]="g.inviteUrl" target="_blank" rel="noopener">{{ g.inviteUrl }}</a></div>
            <div *ngIf="g.observacoes"><span class="text-muted">Obs.:</span> {{ g.observacoes }}</div>
          </div>
        </div>
      </div>

      <div class="modal-footer" *ngIf="grupoSelecionado() as g">
        <button type="button" class="btn btn-outline-secondary" (click)="copyInvite(g)">
          <i class="bi bi-clipboard me-1"></i> Copiar link
        </button>
        <button type="button" class="btn btn-outline-success" (click)="shareWhatsApp(g)">
          <i class="bi bi-whatsapp me-1"></i> WhatsApp
        </button>
        <a class="btn btn-dark" [routerLink]="['/grupos', g.id]">
          <i class="bi bi-box-arrow-in-right me-1"></i> Abrir grupo
        </a>
      </div>
    </div>
  </div>
</div>
