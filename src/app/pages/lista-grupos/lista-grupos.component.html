<app-header></app-header>
<br>

<div class="container py-5 mt-5">

  <!-- Título + ações -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 py-4">
    <h3 class="mb-0 fw-bold text-success">
      <i class="bi bi-people-fill me-2"></i>Grupos Solidários
    </h3>

    <div class="btn-group">
      <button class="btn btn-outline-secondary" [class.active]="visualizacao() === 'cards'"
        (click)="trocarVisualizacao('cards')">
        <i class="bi bi-grid-3x3-gap me-1"></i> Cards
      </button>
      <button class="btn btn-outline-secondary" [class.active]="visualizacao() === 'tabela'"
        (click)="trocarVisualizacao('tabela')">
        <i class="bi bi-table me-1"></i> Tabela
      </button>
      <button class="btn btn-success" (click)="gerarPDF()">
        <i class="bi bi-filetype-pdf me-1"></i> Relatório (PDF)
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="border rounded p-3 h-100">
        <div class="small text-muted">Total de grupos</div>
        <div class="fs-4 fw-bold">{{ kpiTotal() }}</div>
      </div>
    </div>
    <div class="col-6 col-md-9 d-flex align-items-center">
      <div class="text-muted small">
        {{ gruposFiltrados().length }} após filtros
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="border rounded p-3 mb-3">
    <div class="row g-2">
      <div class="col-12 col-md-3">
        <label class="form-label">Nome</label>
        <input class="form-control" [ngModel]="filtro().nome" (ngModelChange)="setFiltro('nome',$event)"
          placeholder="Buscar por nome..." />
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Status</label>
        <select class="form-select" [ngModel]="filtro().status" (ngModelChange)="setFiltro('status',$event)">
          <option value="">Todos</option>
          <option *ngFor="let s of statusDisponiveis()" [value]="s">{{ s | titlecase }}</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Cidade</label>
        <select class="form-select" [ngModel]="filtro().cidade" (ngModelChange)="setFiltro('cidade',$event)">
          <option value="">Todas</option>
          <option *ngFor="let c of cidadesDisponiveis()" [value]="c">{{ c }}</option>
        </select>
      </div>

      <div class="col-6 col-md-1">
        <label class="form-label">UF</label>
        <select class="form-select" [ngModel]="filtro().uf" (ngModelChange)="setFiltro('uf',$event)">
          <option value="">Todas</option>
          <option *ngFor="let u of ufsDisponiveis()" [value]="u">{{ u }}</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Coordenador</label>
        <select class="form-select" [ngModel]="filtro().coordenador" (ngModelChange)="setFiltro('coordenador',$event)">
          <option value="">Todos</option>
          <option *ngFor="let a of coordenadoresDisponiveis()" [value]="a">{{ a }}</option>
        </select>
      </div>

      <div class="col-6 col-md-1">
        <label class="form-label">De</label>
        <input type="date" class="form-control" [ngModel]="filtro().criadoDe"
          (ngModelChange)="setFiltro('criadoDe',$event)" />
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label">Até</label>
        <input type="date" class="form-control" [ngModel]="filtro().criadoAte"
          (ngModelChange)="setFiltro('criadoAte',$event)" />
      </div>
    </div>
  </div>

  <!-- Loading / erro -->
  <div *ngIf="carregando()" class="alert alert-info">Carregando grupos...</div>
  <div *ngIf="!carregando() && erroCarregar()" class="alert alert-danger">{{ erroCarregar() }}</div>

  <!-- CARDS -->
  <div *ngIf="!carregando() && visualizacao() === 'cards'">
    <div class="row g-3">
      <div class="col-12 col-md-6 col-lg-4" *ngFor="let g of gruposPaginados(); trackBy: trackById">
        <div class="card h-100 shadow-sm rounded-4">
          <div class="card-body d-flex flex-column gap-2">
            <div class="d-flex justify-content-between align-items-start">
              <h5 class="card-title mb-0">{{ g.nome }}</h5>
              <span class="badge {{ statusBadgeClass(g._statusDerivado || g.status) }}">{{ (g._statusDerivado ||
                g.status) | titlecase }}</span>
            </div>

            <div class="small text-muted mb-2">
              Criado em: <strong>{{ toBRDate(g.criadoEm) }}</strong> às {{ toBRTime(g.criadoEm) }}
            </div>

            <div class="mb-2">
              <div class="small">Coordenador: <strong>{{ g.coordenadorNome ? (g.coordenadorNome | titlecase) : '—'
                  }}</strong></div>
              <div class="small">Local: <strong>{{ g.cidade || '—' }}/{{ g.uf || '—' }}</strong></div>
              <div class="small">Membros: <strong>{{ g.membrosCount }}</strong></div>
            </div>

            <div class="mt-auto d-flex gap-2">
              <button class="btn btn-outline-primary flex-fill" (click)="abrirEditar(g)">
                <i class="bi bi-pencil-square me-1"></i> Editar
              </button>
              <button class="btn btn-outline-success flex-fill" (click)="grupoSelecionado.set(g); abrirDistribuicao()">
                <i class="bi bi-diagram-3 me-1"></i> Distribuir
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginação -->
    <nav class="mt-3" *ngIf="totalPaginas() > 1">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="paginaAtual() === 1">
          <button class="page-link" (click)="irParaPagina(paginaAtual()-1)">Anterior</button>
        </li>
        <li class="page-item" *ngFor="let p of pages()" [class.active]="p === paginaAtual()">
          <button class="page-link" (click)="irParaPagina(p)">{{ p }}</button>
        </li>
        <li class="page-item" [class.disabled]="paginaAtual() === totalPaginas()">
          <button class="page-link" (click)="irParaPagina(paginaAtual()+1)">Próxima</button>
        </li>
      </ul>
    </nav>
  </div>

  <!-- TABELA -->
  <div *ngIf="!carregando() && visualizacao() === 'tabela'" class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th (click)="ordenarPor('nome')" role="button">Nome</th>
          <th (click)="ordenarPor('status')" role="button">Status</th>
          <th (click)="ordenarPor('cidade')" role="button">Cidade</th>
          <th (click)="ordenarPor('uf')" role="button">UF</th>
          <th (click)="ordenarPor('membrosCount')" role="button">Membros</th>
          <th (click)="ordenarPor('criadoEm')" role="button">Criado em</th>
          <th style="width: 240px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let g of gruposPaginados(); trackBy: trackById">
          <td class="fw-semibold">{{ g.nome }}</td>
          <td><span class="badge {{ statusBadgeClass(g._statusDerivado || g.status) }}">{{ (g._statusDerivado ||
              g.status) | titlecase }}</span></td>
          <td>{{ g.cidade || '—' }}</td>
          <td>{{ g.uf || '—' }}</td>
          <td>{{ g.membrosCount }}</td>
          <td>{{ toBRDate(g.criadoEm) }} {{ toBRTime(g.criadoEm) }}</td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" (click)="abrirEditar(g)">Editar</button>
              <button class="btn btn-sm btn-outline-success"
                (click)="grupoSelecionado.set(g); abrirDistribuicao()">Distribuir</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Paginação -->
    <nav class="mt-2" *ngIf="totalPaginas() > 1">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="paginaAtual() === 1">
          <button class="page-link" (click)="irParaPagina(paginaAtual()-1)">Anterior</button>
        </li>
        <li class="page-item" *ngFor="let p of pages()" [class.active]="p === paginaAtual()">
          <button class="page-link" (click)="irParaPagina(p)">{{ p }}</button>
        </li>
        <li class="page-item" [class.disabled]="paginaAtual() === totalPaginas()">
          <button class="page-link" (click)="irParaPagina(paginaAtual()+1)">Próxima</button>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- MODAL EDITAR -->
<div class="modal fade show" tabindex="-1" style="display:block; background: rgba(0,0,0,.35);"
  *ngIf="modalEditarAberto()">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" *ngIf="grupoSelecionado() as g">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square me-2"></i>
          {{ g.nome }}
          <span class="badge ms-2 {{ statusBadgeClass(g._statusDerivado || g.status) }}">
            {{ (g._statusDerivado || g.status) | titlecase }}
          </span>
        </h5>
        <button type="button" class="btn-close" (click)="fecharEditar()"></button>
      </div>

      <div class="modal-body" *ngIf="grupoSelecionado() as g">
        <div class="row g-3">
          <div class="col-12 col-md-8">
            <div class="d-flex align-items-center justify-content-between">
              <div class="fw-semibold">Integrantes ({{ g.membrosIds.length }})</div>
              <button class="btn btn-sm btn-success" (click)="abrirAdd()">
                <i class="bi bi-person-plus me-1"></i> Adicionar integrante
              </button>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-12 col-sm-6 col-lg-4" *ngFor="let mid of g.membrosIds">
                <div class="border rounded-3 p-2 h-100 d-flex flex-column">
                  <div class="fw-semibold text-truncate">{{ getPreNome(mid) || '—' }}</div>
                  <div class="small text-muted">
                    <div class="text-truncate">CPF: {{ getPreCpf(mid) }}</div>
                    <div class="text-truncate">Fone: {{ getPreTel(mid) }}</div>
                    <div class="text-truncate">Local: {{ getPreLocal(mid) }}</div>
                    <div class="text-truncate">Aprovação: {{ getPreAprovacao(mid) }}</div>
                  </div>
                  <div class="mt-auto d-flex justify-content-end">
                    <button class="btn btn-outline-danger btn-sm" (click)="removerMembro(mid)">
                      <i class="bi bi-person-dash me-1"></i> Remover
                    </button>
                  </div>
                </div>
              </div>

              <div *ngIf="!g.membrosIds.length" class="text-muted small mt-2">Sem integrantes.</div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="border rounded-3 p-3">
              <div class="fw-semibold mb-2">Dados do grupo</div>
              <div class="small mb-1"><span class="text-muted">Coordenador:</span> <b>{{ g.coordenadorNome || '—' }}</b>
              </div>
              <div class="small mb-1"><span class="text-muted">Local:</span> <b>{{ g.cidade || '—' }}/{{ g.uf || '—'
                  }}</b></div>
              <div class="small mb-1"><span class="text-muted">Capacidade:</span> <b>{{ g.capacidadeMin }}–{{
                  g.capacidadeMax }}</b></div>
              <div class="small mb-1"><span class="text-muted">Criado em:</span> <b>{{ toBRDate(g.criadoEm) }}</b> {{
                toBRTime(g.criadoEm) }}</div>
              <div class="small"><span class="text-muted">Obs.:</span> {{ g.observacoes || '—' }}</div>

              <hr class="my-3">

              <div class="fw-semibold mb-2">Distribuição (resumo)</div>
              <div class="small">Assessor do grupo: <b>{{ distGroupAssessorNome() || '—' }}</b></div>
              <button class="btn btn-outline-success btn-sm mt-2" (click)="abrirDistribuicao()">
                <i class="bi bi-diagram-3 me-1"></i> Abrir distribuição
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="fecharEditar()">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL ADICIONAR INTEGRANTE -->
<div class="modal fade show" tabindex="-1" style="display:block; background: rgba(0,0,0,.35);" *ngIf="modalAddAberto()">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-person-plus me-2"></i>Adicionar integrante
        </h5>
        <button type="button" class="btn-close" (click)="fecharAdd()"></button>
      </div>

      <div class="modal-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-8">
            <label class="form-label">Buscar</label>
            <input class="form-control" [ngModel]="buscaCandidato()" (ngModelChange)="buscaCandidato.set($event)"
              placeholder="nome, CPF, cidade, UF..." />
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Filtro</label>
            <div class="form-check">
              <input id="chkAptos" class="form-check-input" type="checkbox" [ngModel]="apenasAptos()"
                (ngModelChange)="apenasAptos.set($event)" />
              <label class="form-check-label" for="chkAptos">Apenas aptos</label>
            </div>
          </div>
        </div>

        <div class="mt-3" style="max-height: 380px; overflow:auto;">
          <div class="border rounded-3 p-2 mb-2 d-flex align-items-center justify-content-between"
            *ngFor="let p of candidatosFiltrados()">
            <div class="me-3" style="min-width:0">
              <div class="fw-semibold text-truncate">{{ p.nomeCompleto || '—' }}</div>
              <div class="small text-muted text-truncate">
                CPF: {{ p.cpf || '—' }} • {{ p.cidade || '—' }}/{{ p.uf || '—' }} • {{ p.aprovacaoStatus || '—' }}
              </div>
            </div>
            <button class="btn btn-sm btn-success" (click)="adicionarMembro(p.id)">
              <i class="bi bi-plus-lg me-1"></i> Adicionar
            </button>
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="fecharAdd()">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DISTRIBUIÇÃO -->
<div class="modal fade show" tabindex="-1" style="display:block; background: rgba(0,0,0,.35);"
  *ngIf="modalDistribAberto() && grupoSelecionado() as g">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-diagram-3 me-2"></i>Distribuir grupo — {{ g.nome }}
        </h5>
        <button type="button" class="btn-close" (click)="fecharDistribuicao()"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <div class="fw-semibold">Assessor do grupo</div>
          <select class="form-select form-select-sm mt-1" [value]="distGroupAssessorUid()"
            (change)="onChangeAssessorGrupo($event)">
            <option value="">Escolha o Assessor</option>
            <option *ngFor="let a of assessores()" [value]="a.uid">{{ a.nome | titlecase }}</option>
          </select>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="fecharDistribuicao()">Fechar</button>
      </div>
    </div>
  </div>
</div>