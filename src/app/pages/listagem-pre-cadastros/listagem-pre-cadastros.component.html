<app-header></app-header>
<br />
<div class="container py-5 mt-5">
  <!-- Título -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 py-4">
    <h3 class="mb-0 fw-bold text-success">
      <i class="bi bi-card-list me-2"></i>Pré-cadastros
    </h3>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" (click)="recarregarTudo()">
        <i class="fa-solid fa-rotate-right me-1"></i> Recarregar
      </button>
      <button class="btn btn-success" (click)="abrirRelatorioModal()">
        <i class="fa-solid fa-clipboard-list me-1"></i> Relatório (visualizar)
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="crn-kpi row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="crn-kpi__card">
        <div class="crn-kpi__label">Total estimado</div>
        <div class="crn-kpi__value">{{ totalEstimado }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="crn-kpi__card">
        <div class="crn-kpi__label">Carregados</div>
        <div class="crn-kpi__value">{{ presAll.length || 0 }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="crn-kpi__card">
        <div class="crn-kpi__label">Após filtros</div>
        <div class="crn-kpi__value">{{ presFiltrados.length || 0 }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="crn-kpi__card">
        <div class="crn-kpi__label">Busca por nome</div>
        <div class="crn-kpi__value">{{ filtro.nome ? 'Ativo' : '—' }}</div>
        <div class="crn-kpi__hint">{{ filtro.nome || 'sem filtro' }}</div>
      </div>
    </div>
  </div>

  <!-- Estado -->
  <div *ngIf="carregando && presAll.length===0" class="alert alert-info py-2">Carregando pré-cadastros...</div>
  <div *ngIf="!carregando && erroCarregar" class="alert alert-primary-subtle text-primary-emphasis border">
    {{ erroCarregar }}
  </div>

  <!-- ===================== Filtros ===================== -->
  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <!-- Nome -->
        <div class="col-md-4">
          <label class="form-label">Buscar por nome</label>
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Digite o nome"
                   [(ngModel)]="filtro.nome" (ngModelChange)="onFiltroNomeChange($event)" />
            <button class="btn btn-success" (click)="aplicarFiltrosLocais(true)">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>

        <!-- Criado em -->
        <div class="col-md-3">
          <label class="form-label">Criado de</label>
          <input type="date" class="form-control" [(ngModel)]="filtro.dataDe" (change)="aplicarFiltrosLocais(true)" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Até</label>
          <input type="date" class="form-control" [(ngModel)]="filtro.dataAte" (change)="aplicarFiltrosLocais(true)" />
        </div>

        <!-- Agendado -->
        <div class="col-md-2">
          <label class="form-label">Agendados</label>
          <select class="form-select" [(ngModel)]="filtro.agendado" (change)="aplicarFiltrosLocais(true)">
            <option value="todos">Todos</option>
            <option value="sim">Somente agendados</option>
            <option value="nao">Somente não agendados</option>
          </select>
        </div>

        <!-- Assessor -->
        <div class="col-md-4">
          <label class="form-label">Assessor responsável</label>
          <select class="form-select" [(ngModel)]="filtro.assessor" (change)="aplicarFiltrosLocais(true)">
            <option value="">Todos</option>
            <option value="(sem assessor)">Sem assessor</option>
            <option *ngFor="let a of assessoresDisponiveis" [value]="a">{{ a }}</option>
          </select>
        </div>

        <!-- Bairro -->
        <div class="col-md-3">
          <label class="form-label">Bairro</label>
          <select class="form-select" [(ngModel)]="filtro.bairro" (change)="aplicarFiltrosLocais(true)">
            <option value="">Todos</option>
            <option *ngFor="let b of bairrosDisponiveis" [value]="b">{{ b }}</option>
          </select>
        </div>

        <!-- Cidade -->
        <div class="col-md-3">
          <label class="form-label">Cidade</label>
          <select class="form-select" [(ngModel)]="filtro.cidade" (change)="aplicarFiltrosLocais(true)">
            <option value="">Todas</option>
            <option *ngFor="let c of cidadesDisponiveis" [value]="c">{{ c }}</option>
          </select>
        </div>

        <!-- UF -->
        <div class="col-md-2">
          <label class="form-label">UF</label>
          <select class="form-select" [(ngModel)]="filtro.uf" (change)="aplicarFiltrosLocais(true)">
            <option value="">Todas</option>
            <option *ngFor="let u of ufsDisponiveis" [value]="u">{{ u }}</option>
          </select>
        </div>

        <!-- Origem -->
        <div class="col-md-3">
          <label class="form-label">Origem</label>
          <select class="form-select" [(ngModel)]="filtro.origem" (change)="aplicarFiltrosLocais(true)">
            <option value="">Todas</option>
            <option *ngFor="let o of origensDisponiveis" [value]="o">{{ o }}</option>
          </select>
        </div>

        <!-- Período do agendamento -->
        <div class="col-md-3">
          <label class="form-label">Agendamento de</label>
          <input type="date" class="form-control" [(ngModel)]="filtro.agDataDe" (change)="aplicarFiltrosLocais(true)" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Até</label>
          <input type="date" class="form-control" [(ngModel)]="filtro.agDataAte" (change)="aplicarFiltrosLocais(true)" />
        </div>

        <!-- Status do agendamento -->
        <div class="col-md-3">
          <label class="form-label">Status do agendamento</label>
          <select class="form-select" [(ngModel)]="filtro.agStatus" (change)="aplicarFiltrosLocais(true)">
            <option value="">Todos</option>
            <option *ngFor="let s of agStatusDisponiveis" [value]="s">{{ s }}</option>
          </select>
        </div>

        <!-- Status de aprovação -->
        <div class="col-md-3">
          <label class="form-label">Status de aprovação</label>
          <select class="form-select" [(ngModel)]="filtro.aprovStatus" (change)="onAprovacaoChange()">
            <option value="">Todos</option>
            <!-- As três opções canônicas sempre aparecem;
                 a lista dinâmica pode acrescentar rótulos equivalentes se existirem -->
            <option *ngFor="let s of aprovStatusDisponiveis" [value]="s">{{ s }}</option>
          </select>
        </div>

        <!-- Visualização -->
        <div class="col-md-4">
          <label class="form-label">Visualização</label>
          <select class="form-select" [(ngModel)]="visualizacao" (change)="aplicarFiltrosLocais(true)">
            <option value="cards">Cards (rápido)</option>
            <option value="tabela">Tabela</option>
            <option value="porAssessor">Agrupar por assessor</option>
            <option value="porOrigem">Agrupar por origem</option>
            <option value="porStatus">Agrupar por status</option>
          </select>
        </div>

        <!-- Itens por página (só afeta a tabela) -->
        <div class="col-md-2">
          <label class="form-label">Itens por página</label>
          <select class="form-select" [(ngModel)]="itensPorPagina" (change)="aplicarFiltrosLocais(true)">
            <option *ngFor="let n of [10,20,30,50,100]" [value]="n">{{ n }}</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== Cards responsivos ===================== -->
  <div *ngIf="visualizacao==='cards'">
    <div class="row g-3 row-cols-1 row-cols-sm-2 row-cols-lg-3">
      <div class="col" *ngFor="let c of presFiltrados; trackBy: trackById">
        <div class="crn-card card h-100 shadow-sm rounded-4">
          <div class="card-body d-flex flex-column gap-2">
            <div class="d-flex align-items-start justify-content-between gap-2">
              <h6 class="mb-0 fw-bold text-success-emphasis text-truncate" [title]="displayName(c.nomeCompleto)">
                {{ displayName(c.nomeCompleto) || '—' }}
              </h6>
              <span class="badge"
                    [ngClass]="{
                      'text-bg-success': getAprovacaoStatus(c)==='Apto',
                      'text-bg-danger':  getAprovacaoStatus(c)==='Inapto',
                      'text-bg-secondary': getAprovacaoStatus(c)==='Pendente' || getAprovacaoStatus(c)==='—'
                    }">
                {{ getAprovacaoStatus(c) }}
              </span>
            </div>

            <div class="small text-muted">
              <div class="text-truncate"><i class="fa-regular fa-calendar me-1"></i>{{ toBRDate(c.createdAt) }}</div>
              <div class="text-truncate" *ngIf="getAssessorNome(c) !== '(sem assessor)'">
                <i class="fa-solid fa-user-tie me-1"></i>{{ getAssessorNome(c) }}
              </div>
              <div class="text-truncate" *ngIf="getPhone(c)">
                <i class="fa-solid fa-phone me-1"></i>{{ maskPhone(getPhone(c)) }}
              </div>
              <div class="text-truncate">
                <i class="fa-solid fa-location-dot me-1"></i>{{ getBairro(c) }} — {{ getCidade(c) }} / {{ getUF(c) }}
              </div>
              <div class="text-truncate"><i class="fa-solid fa-hashtag me-1"></i>{{ getOrigem(c) }}</div>
              <div class="text-truncate">
                <i class="fa-regular fa-clock me-1"></i>
                <strong>{{ isAgendado(c) ? 'Agendado:' : 'Sem agendamento' }}</strong>
                <span *ngIf="isAgendado(c)"> — {{ getAgendamentoResumo(c) }}</span>
              </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-2">
              <button class="btn btn-outline-success btn-sm" (click)="editarPreCadastro(c)">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-outline-danger btn-sm" (click)="removerPreCadastro(c)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vazio / carregando -->
    <div *ngIf="carregando" class="text-center text-muted small mt-2">Carregando…</div>
    <div *ngIf="!carregando && presFiltrados.length===0" class="text-center text-muted py-4">
      Nenhum pré-cadastro encontrado
    </div>
  </div>

  <!-- ===================== Tabela padrão (opcional) ===================== -->
  <div *ngIf="visualizacao==='tabela'" class="table-responsive shadow-sm rounded-4 border">
    <table class="table table-hover align-middle mb-0">
      <thead class="sticky-top" style="z-index:1;background:#eaf6ef">
        <tr class="text-success">
          <th style="width:26%; cursor:pointer" (click)="ordenarPor('nomeCompleto')">
            <div class="d-inline-flex align-items-center gap-2">
              <span>Nome</span>
              <i *ngIf="sortField==='nomeCompleto' && sortDir==='asc'" class="fa-solid fa-arrow-up"></i>
              <i *ngIf="sortField==='nomeCompleto' && sortDir==='desc'" class="fa-solid fa-arrow-down"></i>
            </div>
          </th>
          <th style="width:220px; cursor:pointer" (click)="ordenarPor('assessorNome')">
            <div class="d-inline-flex align-items-center gap-2">
              <span>Assessor responsável</span>
              <i *ngIf="sortField==='assessorNome' && sortDir==='asc'" class="fa-solid fa-arrow-up"></i>
              <i *ngIf="sortField==='assessorNome' && sortDir==='desc'" class="fa-solid fa-arrow-down"></i>
            </div>
          </th>
          <th style="width:130px">Telefone</th>
          <th style="width:150px; cursor:pointer" (click)="ordenarPor('createdAt')">
            <div class="d-inline-flex align-items-center gap-2">
              <span>Criado em</span>
              <i *ngIf="sortField==='createdAt' && sortDir==='asc'" class="fa-solid fa-arrow-up"></i>
              <i *ngIf="sortField==='createdAt' && sortDir==='desc'" class="fa-solid fa-arrow-down"></i>
            </div>
          </th>
          <th style="width:240px">Agendamento</th>
          <th style="width:180px; cursor:pointer" (click)="ordenarPor('bairro')">
            <div class="d-inline-flex align-items-center gap-2">
              <span>Bairro</span>
              <i *ngIf="sortField==='bairro' && sortDir==='asc'" class="fa-solid fa-arrow-up"></i>
              <i *ngIf="sortField==='bairro' && sortDir==='desc'" class="fa-solid fa-arrow-down"></i>
            </div>
          </th>
          <th style="width:160px">Origem</th>
          <th style="width:150px">Aprovação</th>
          <th style="width:150px">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of presPaginados; trackBy: trackById">
          <td class="fw-semibold text-success-emphasis text-truncate" style="max-width: 420px;">
            {{ displayName(c.nomeCompleto) || '—' }}
          </td>
          <td class="text-truncate" style="max-width: 240px;">{{ getAssessorNome(c) }}</td>
          <td>{{ maskPhone(getPhone(c)) }}</td>
          <td>{{ toBRDate(c.createdAt) }}</td>
          <td class="text-truncate" style="max-width: 260px;">
            <span class="badge me-1" [class.text-bg-success]="isAgendado(c)" [class.text-bg-secondary]="!isAgendado(c)">
              {{ isAgendado(c) ? 'Agendado' : 'Sem agendamento' }}
            </span>
            <span *ngIf="isAgendado(c)">— {{ getAgendamentoResumo(c) }}</span>
          </td>
          <td class="text-truncate" style="max-width: 200px;">{{ getBairro(c) }}</td>
          <td class="text-truncate" style="max-width: 160px;">{{ getOrigem(c) }}</td>
          <td>
            <span class="badge"
                  [ngClass]="{
                    'text-bg-success': getAprovacaoStatus(c)==='Apto',
                    'text-bg-danger':  getAprovacaoStatus(c)==='Inapto',
                    'text-bg-secondary': getAprovacaoStatus(c)==='Pendente' || getAprovacaoStatus(c)==='—'
                  }">
              {{ getAprovacaoStatus(c) }}
            </span>
          </td>
          <td class="text-nowrap">
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-success" (click)="editarPreCadastro(c)">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="removerPreCadastro(c)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="!carregando && presPaginados.length === 0">
          <td colspan="9" class="text-center text-muted py-4">Nenhum pré-cadastro encontrado</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Paginação local (só quando tabela) -->
  <nav class="mt-4" *ngIf="visualizacao==='tabela' && totalPaginas > 1">
    <ul class="pagination justify-content-center flex-wrap gap-1">
      <li class="page-item" [class.disabled]="paginaAtual === 1">
        <button class="page-link" (click)="irParaPagina(paginaAtual - 1)">Anterior</button>
      </li>
      <li class="page-item" *ngFor="let p of pages()" [class.active]="paginaAtual === p">
        <button class="page-link" (click)="irParaPagina(p)">{{ p }}</button>
      </li>
      <li class="page-item" [class.disabled]="paginaAtual === totalPaginas">
        <button class="page-link" (click)="irParaPagina(paginaAtual + 1)">Próxima</button>
      </li>
    </ul>
  </nav>
</div>

<!-- ======================= MODAL DE RELATÓRIO ======================= -->
<div class="modal fade show" tabindex="-1" role="dialog"
     *ngIf="relatorioAberto"
     style="display:block; background: rgba(0,0,0,.35);">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title">
          Relatório de Pré-cadastros – CRENORTE
          <small class="text-muted d-block fs-6">Gerado em {{ relatorioGeradoEm }}</small>
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="fecharRelatorioModal()"></button>
      </div>

      <div class="modal-body">
        <!-- KPIs -->
        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3"><div class="border rounded-3 p-3"><div class="text-muted">Carregados</div><div class="fs-4 fw-bold">{{ kpiCarregados }}</div></div></div>
          <div class="col-6 col-md-3"><div class="border rounded-3 p-3"><div class="text-muted">Após filtros</div><div class="fs-4 fw-bold">{{ kpiFiltrados }}</div></div></div>
          <div class="col-6 col-md-3"><div class="border rounded-3 p-3"><div class="text-muted">Agendados</div><div class="fs-4 fw-bold">{{ kpiAgendados }}</div></div></div>
          <div class="col-6 col-md-3"><div class="border rounded-3 p-3"><div class="text-muted">Sem agendamento</div><div class="fs-4 fw-bold">{{ kpiSemAgendamento }}</div></div></div>
        </div>

        <!-- Resumo filtros -->
        <div class="small text-muted mb-3">Filtros aplicados: {{ resumoFiltros }}</div>

        <!-- Tabela do relatório -->
        <div class="table-responsive border rounded-3">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-success">
              <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Criado em</th>
                <th>Agendado</th>
                <th>Data/Hora Ag.</th>
                <th>Status</th>
                <th>Aprovação</th>
                <th>Bairro</th>
                <th>Cidade</th>
                <th>UF</th>
                <th>Origem</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let d of relDetalhes">
                <td class="text-truncate" style="max-width:260px">{{ d.nome }}</td>
                <td>{{ d.telefone }}</td>
                <td>{{ d.criado }}</td>
                <td>{{ d.agendado }}</td>
                <td>{{ d.agDataHora }}</td>
                <td>{{ d.agStatus }}</td>
                <td>{{ d.aprovStatus }}</td>
                <td class="text-truncate" style="max-width:160px">{{ d.bairro }}</td>
                <td class="text-truncate" style="max-width:160px">{{ d.cidade }}</td>
                <td>{{ d.uf }}</td>
                <td>{{ d.origem }}</td>
              </tr>
              <tr *ngIf="relDetalhes.length===0">
                <td colspan="11" class="text-center text-muted py-4">Nenhum registro para exibir</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="fecharRelatorioModal()">Fechar</button>
        <button class="btn btn-success" (click)="gerarRelatorioPDF()">
          <i class="fa-solid fa-file-pdf me-1"></i> Baixar PDF
        </button>
      </div>
    </div>
  </div>
</div>
