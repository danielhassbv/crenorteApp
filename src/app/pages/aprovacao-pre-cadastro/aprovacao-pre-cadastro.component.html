<div class="container py-3">

  <!-- Header + Filtros + Relatório -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h2 class="mb-2 mb-md-0">Aprovação de Pré-cadastro</h2>

    <div class="d-flex flex-wrap gap-2">

      <!-- Filtro: Assessor (autor) -->
      <div class="input-group">
        <span class="input-group-text">Assessor</span>
        <select class="form-select" [value]="filtroAssessor()" #selAss
                (change)="onFiltroAssessorChange(selAss.value)">
          <option value="todos">Todos</option>
          <option *ngFor="let a of autoresOptions()" [value]="a.uid">{{ a.nome }}</option>
        </select>
      </div>

      <!-- Filtro: Data de/até -->
      <div class="input-group">
        <span class="input-group-text">De</span>
        <input type="date" class="form-control" [value]="filtroDataDe() || ''"
               (input)="onFiltroDataDeChange($any($event.target).value)">
        <span class="input-group-text">Até</span>
        <input type="date" class="form-control" [value]="filtroDataAte() || ''"
               (input)="onFiltroDataAteChange($any($event.target).value)">
      </div>

      <!-- Filtro: Status -->
      <div class="input-group">
        <span class="input-group-text">Aprovação</span>
        <select class="form-select" [value]="filtroAprovacao()" #selAprov
                (change)="onChangeAprovacao(selAprov.value)">
          <option value="todos">Todos</option>
          <option value="nao_verificado">Não verificados</option>
          <option value="apto">Aptos</option>
          <option value="inapto">Inaptos</option>
        </select>
      </div>

      <!-- Relatório -->
      <button class="btn btn-outline-secondary" (click)="relatorioAberto.set(true)">
        Relatório de Aprovação
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="alert alert-light border-0 shadow-sm d-flex align-items-center gap-2">
    <span class="spinner-border spinner-border-sm"></span>
    Carregando…
  </div>

  <!-- PAGINAÇÃO (topo) -->
  <nav *ngIf="!loading() && filtrados().length"
       class="px-2 py-2 mb-2 d-flex flex-wrap align-items-center justify-content-between gap-2"
       aria-label="Paginação">
    <div class="small text-muted">
      Mostrando {{ pageStart + 1 }}–{{ pageEnd }} de {{ totalItems }}
    </div>
    <div class="d-flex align-items-center gap-2">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="currentPage===1">
          <a class="page-link" (click)="prevPage()" role="button" aria-label="Página anterior">‹</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">{{ currentPage }} / {{ totalPages }}</span>
        </li>
        <li class="page-item" [class.disabled]="currentPage===totalPages">
          <a class="page-link" (click)="nextPage()" role="button" aria-label="Próxima página">›</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Lista -->
  <div *ngFor="let item of pageItems()" class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between">
        <!-- ESQUERDA: dados do cliente -->
        <div class="pe-3">
          <strong>{{ item.nomeCompleto }}</strong>
          <div class="text-muted">
            CPF {{ item.cpf }} • {{ item.bairro }} • Origem: {{ item.origem }}
          </div>

          <!-- autor + total do autor -->
          <div class="small text-muted mt-1">
            Criado por:
            <strong>{{ nomeDoAutor(item.createdByUid) }}</strong>
            <ng-container *ngIf="item.createdByUid">
              ({{ totalDoAutor(item.createdByUid) }} cadastros)
            </ng-container>
          </div>

          <div *ngIf="item.valorSolicitado" class="mt-1">
            Solicitado: <strong>R${{ item.valorSolicitado | number:'1.0-0' }}</strong>
          </div>

          <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
            <span class="fw-semibold">Status aprovação:</span>

            <span class="badge"
                  [ngClass]="{
                    'text-bg-secondary': (item.aprovacao?.status || 'nao_verificado')==='nao_verificado',
                    'text-bg-danger':    (item.aprovacao?.status || 'nao_verificado')==='inapto',
                    'text-bg-success':   (item.aprovacao?.status || 'nao_verificado')==='apto'
                  }">
              {{
                (item.aprovacao?.status || 'nao_verificado')==='nao_verificado' ? 'Não verificado' :
                (item.aprovacao?.status==='apto' ? 'Apto' : 'Inapto')
              }}
            </span>

            <!-- Motivo quando INAPTO -->
            <small class="text-danger" *ngIf="(item.aprovacao?.status||'')==='inapto'">
              Motivo: {{ item.aprovacao?.motivo || item.aprovacao?.observacao || '—' }}
            </small>

            <small class="text-muted" *ngIf="$any(item)?.aprovacao?.porNome">
              por {{ $any(item).aprovacao.porNome }}
              <ng-container *ngIf="$any(item)?.aprovacao?.em as aem">
                — {{ (aem?.toDate ? aem.toDate() : aem) | date:'dd/MM/yyyy HH:mm' }}
              </ng-container>
            </small>

            <span *ngIf="item.encaminhamento?.assessorNome" class="badge text-bg-primary ms-2">
              Enviado: {{ item.encaminhamento?.assessorNome }}
            </span>
          </div>
        </div>

        <!-- DIREITA: ações -->
        <div class="text-end">
          <div class="d-flex justify-content-end gap-2 mb-2">
            <button class="btn btn-outline-success"
                    [disabled]="(item.aprovacao?.status || 'nao_verificado')==='apto'"
                    (click)="marcarApto(item)">
              Aprovar (Apto)
            </button>

            <button class="btn btn-outline-danger"
                    [disabled]="(item.aprovacao?.status || 'nao_verificado')==='inapto'"
                    (click)="abrirModalInapto(item)">
              Marcar Inapto
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGINAÇÃO (base) -->
  <nav *ngIf="!loading() && filtrados().length"
       class="px-2 py-2 mt-2 d-flex flex-wrap align-items-center justify-content-between gap-2"
       aria-label="Paginação">
    <div class="small text-muted">
      Mostrando {{ pageStart + 1 }}–{{ pageEnd }} de {{ totalItems }}
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="small text-muted me-1">por página</label>
      <select class="form-select form-select-sm w-auto"
              [ngModel]="pageSize"
              (ngModelChange)="onPageSizeChange($event)">
        <option [ngValue]="10">10</option>
        <option [ngValue]="20">20</option>
        <option [ngValue]="30">30</option>
        <option [ngValue]="50">50</option>
      </select>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="currentPage===1">
          <a class="page-link" (click)="prevPage()" role="button" aria-label="Página anterior">‹</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">{{ currentPage }} / {{ totalPages }}</span>
        </li>
        <li class="page-item" [class.disabled]="currentPage===totalPages">
          <a class="page-link" (click)="nextPage()" role="button" aria-label="Próxima página">›</a>
        </li>
      </ul>
    </div>
  </nav>

</div>

<!-- ===== Modal: Marcar Inapto ===== -->
<div *ngIf="inaptoAberto()" class="position-fixed top-0 start-0 w-100 h-100"
     style="background: rgba(0,0,0,.35); z-index:1055;">
  <div class="bg-white shadow rounded-3 position-absolute top-50 start-50 translate-middle"
       style="width:min(560px, 96vw);">
    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Motivo da inaptidão</h5>
      <button class="btn btn-sm btn-outline-secondary" (click)="fecharModalInapto()">Fechar</button>
    </div>

    <div class="p-3">
      <label class="form-label">Descreva o motivo / observação</label>
      <textarea #txtMotivo class="form-control" rows="4"
                placeholder="Ex.: Documento divergente, cliente negativado, dados inconsistentes, etc."></textarea>
      <small class="text-muted">Essa observação ficará registrada no histórico da aprovação.</small>
    </div>

    <div class="p-3 border-top d-flex justify-content-end gap-2">
      <button class="btn btn-light" (click)="fecharModalInapto()">Cancelar</button>
      <button class="btn btn-danger"
              (click)="confirmarInapto(txtMotivo.value)">
        Confirmar Inapto
      </button>
    </div>
  </div>
</div>

<!-- ===== Modal: Relatório de Aprovação ===== -->
<div *ngIf="relatorioAberto()" class="position-fixed top-0 start-0 w-100 h-100"
     style="background: rgba(0,0,0,.35); z-index:1055;">
  <div class="bg-white shadow rounded-3 position-absolute top-50 start-50 translate-middle"
       style="width:min(980px, 96vw); max-height:86vh; overflow:auto;">
    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Relatório de Aprovação</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" (click)="exportarRelatorioPDF()">Exportar PDF</button>
        <button class="btn btn-outline-secondary" (click)="relatorioAberto.set(false)">Fechar</button>
      </div>
    </div>

    <!-- Filtros do relatório -->
    <div class="p-3 border-bottom">
      <div class="row g-2">
        <div class="col-12 col-md-4">
          <label class="form-label">Assessor</label>
          <select class="form-select" [value]="relFiltroAssessor()" #relAssSel
                  (change)="onRelFiltroAssessorChange(relAssSel.value)">
            <option value="">Todos</option>
            <option *ngFor="let a of assessores()" [value]="a.uid || a.id">{{ a.nome }}</option>
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">De</label>
          <input type="date" class="form-control"
                 [value]="relFiltroDataDe() || ''"
                 (input)="onRelFiltroDataDeChange($any($event.target).value)">
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Até</label>
          <input type="date" class="form-control"
                 [value]="relFiltroDataAte() || ''"
                 (input)="onRelFiltroDataAteChange($any($event.target).value)">
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Cliente</label>
          <input type="text" class="form-control" placeholder="Nome"
                 [value]="relFiltroNome() || ''"
                 (input)="onRelFiltroNomeChange($any($event.target).value)">
        </div>
      </div>
    </div>

    <!-- Conteúdo do relatório -->
    <div class="p-3" id="relatorio-aprovacao">

      <p class="mb-2">
        <strong>Total de aptos:</strong> {{ relatorio().total }}
      </p>

      <!-- Aptos pendentes -->
      <div class="mb-4" *ngIf="relatorio().pendentes.length">
        <h6 class="mb-2">Aptos pendentes (sem assessor)</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>CPF</th>
                <th>Criado em</th>
                <th>Aprovado em</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let it of relatorio().pendentes">
                <td>{{ it.nomeCompleto }}</td>
                <td>{{ it.cpf }}</td>
                <td>{{ (it.createdAt?.toDate ? it.createdAt.toDate() : it.createdAt) | date:'dd/MM/yyyy HH:mm' }}</td>
                <td>
                  <ng-container *ngIf="$any(it)?.aprovacao?.em as aem">
                    {{ (aem?.toDate ? aem.toDate() : aem) | date:'dd/MM/yyyy HH:mm' }}
                  </ng-container>
                  <ng-container *ngIf="!$any(it)?.aprovacao?.em">—</ng-container>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Aptos por assessor -->
      <div *ngFor="let g of relatorio().grupos" class="mb-4">
        <h6 class="mb-2">
          Assessor: {{ g.assessorNome || g.assessorUid }}
          <span class="text-muted">({{ g.itens.length }})</span>
        </h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>CPF</th>
                <th>Criado em</th>
                <th>Encaminhado em</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let it of g.itens">
                <td>{{ it.nomeCompleto }}</td>
                <td>{{ it.cpf }}</td>
                <td>{{ (it.createdAt?.toDate ? it.createdAt.toDate() : it.createdAt) | date:'dd/MM/yyyy HH:mm' }}</td>
                <td>
                  <ng-container *ngIf="$any(it)?.encaminhamento?.em as eem">
                    {{ (eem?.toDate ? eem.toDate() : eem) | date:'dd/MM/yyyy HH:mm' }}
                  </ng-container>
                  <ng-container *ngIf="!$any(it)?.encaminhamento?.em">—</ng-container>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div *ngIf="!relatorio().total" class="text-muted">
        Nenhum pré-cadastro apto até o momento.
      </div>
    </div>
  </div>
</div>
